<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SET FOTOGRAFICO V19.0 (BETA)</title>

  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042339.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* Identidad base */
      --p:#1e40af;           /* azul institucional */
      --accent:#059669;      /* verde (acciones positivas) */
      --light-green:#2ecc71; /* splash */
      --dark-gray:#334155;

      /* Nuevo fondo continuo (suave, verde claro) */
      --bg:#eaf7ef;

      /* UI */
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;

      /* Botones */
      --btn-sec:#64748b;
      --btn-danger:#ef4444;
      --btn-edit:#f59e0b;  /* edici√≥n/ajuste (girar) */
      --btn-ok:#22c55e;    /* finalizar carga (verde claro) */

      --shadow: 0 0 20px rgba(0,0,0,0.08);
    }

    body.dark{
      /* Tema oscuro: variables */
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2937;

      --shadow: 0 0 20px rgba(0,0,0,0.55);

      /* Ajustes de botones para contraste */
      --btn-sec:#334155;
      --btn-edit:#d97706;
      --btn-ok:#16a34a;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      font-family:'Segoe UI',sans-serif;
      background:var(--bg);
      margin:0; padding:0;
      display:flex; justify-content:center;
      height:100dvh; overflow:hidden;
      color:var(--text);
    }

    .splash-screen{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,var(--light-green) 0%,#ffffff 100%);
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;transition:opacity .5s ease;
    }
    .splash-screen.hidden{opacity:0;pointer-events:none;}
    .splash-icons-cont{display:flex;align-items:center;gap:15px;margin-bottom:20px;}
    .splash-icon{width:70px;height:70px;}
    .splash-cam{fill:var(--dark-gray);}
    .splash-hour{fill:var(--accent);animation:rotateHour 3s infinite linear;}
    @keyframes rotateHour{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .splash-title{font-size:2rem;color:var(--p);margin:0;font-weight:900;letter-spacing:1px;}

    .card{
      background:transparent;
      width:100%;max-width:520px;height:100%;
      display:flex;flex-direction:column;position:relative;
    }

    .app-header{
      background:var(--card);
      border-bottom:1px solid var(--border);
      padding:15px;text-align:center;flex-shrink:0;z-index:10;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }
    body.dark .app-header{ box-shadow: none; }

    .app-header h1{ font-size:1.4rem;margin:0;color:var(--p);font-weight:800; }

    .content{
      padding:18px;
      flex-grow:1;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }

    .app-footer{
      padding:10px 12px;
      text-align:center;
      border-top:1px solid var(--border);
      color:var(--p);
      font-size:.72rem;
      font-weight:800;
      background:var(--card);
      flex-shrink:0;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .footer-sub{
      margin-top:4px;
      font-size:.66rem;
      letter-spacing:.6px;
      color:var(--muted);
      font-weight:800;
      text-transform:none;
    }

    .step{display:none;animation:fadeIn .3s ease;}
    .step.active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

    h2{
      font-size:1.05rem;
      color:var(--dark-gray);
      text-align:center;
      text-transform:uppercase;
      border-bottom:3px solid var(--p);
      padding-bottom:10px;
      margin-top:0;
    }
    body.dark h2{ color: var(--text); }

    input[type="text"], input[type="date"], textarea{
      width:100%;
      padding:14px;
      margin:10px 0;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      background:var(--card);
      color:var(--text);
    }
    textarea{resize:vertical;min-height:80px;}
    input::placeholder, textarea::placeholder{ color: var(--muted); }

    button,.btn-label{
      width:100%;
      padding:16px;
      margin:6px 0;
      border:none;border-radius:10px;
      font-weight:900;
      cursor:pointer;
      color:white;
      text-transform:uppercase;
      font-size:1rem;
      display:block;
      text-align:center;
      transition:transform .1s, opacity .15s;
    }
    button:active,.btn-label:active{transform:scale(.98);}
    button:disabled{opacity:.55;cursor:not-allowed;}

    .btn-main{background:var(--p);}
    .btn-sec{background:var(--btn-sec);}
    .btn-danger{background:var(--btn-danger);font-size:.9rem;margin-top:25px;}
    .btn-mini{padding:10px;font-size:.78rem;border-radius:8px;margin:0;}
    .btn-ok{background:var(--btn-ok);}
    .btn-edit{background:var(--btn-edit);}

    input[type="file"]{display:none;}
    .btn-camara{background:var(--p);display:flex;align-items:center;justify-content:center;gap:10px;}

    .item-foto{
      border:1px solid var(--border);
      padding:12px;margin-bottom:15px;border-radius:12px;
      background:var(--card);
      box-shadow:0 2px 5px rgba(0,0,0,0.05);
    }
    body.dark .item-foto{ box-shadow:none; }

    .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--p);font-weight:900;font-size:.9rem;}
    .btn-delete{color:#ef4444;background:#fee2e2;padding:4px 10px;border-radius:5px;cursor:pointer;}
    body.dark .btn-delete{ background:#3b0a0a; }

    #status{color:var(--accent);font-weight:900;text-align:center;margin:10px 0;min-height:20px;}

    .review-box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:rgba(255,255,255,0.55);
      margin-bottom:15px;
      backdrop-filter: blur(3px);
    }
    body.dark .review-box{
      background:rgba(15,23,42,0.65);
      backdrop-filter:none;
    }
    .review-box label{
      font-weight:900;color:var(--text);display:block;margin-bottom:6px;
      text-transform:uppercase;font-size:.78rem;letter-spacing:.6px;
    }

    .grid-actions-4{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
    .grid-actions-2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
    .hint{font-size:.78rem;color:var(--muted);margin-top:8px;text-align:center;}

    .preview-box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:rgba(255,255,255,0.55);
      margin-top:10px;
      backdrop-filter: blur(3px);
    }
    body.dark .preview-box{ background:rgba(15,23,42,0.65); backdrop-filter:none; }
    .preview-box h3{margin:0 0 8px 0;font-size:.85rem;color:var(--text);text-transform:uppercase;letter-spacing:.5px;}
    #previewImg{
      width:100%;max-height:180px;object-fit:contain;
      background:var(--card);border-radius:10px;border:1px solid var(--border);
      display:none;
    }

    /* Men√∫: tarjetas */
    .menu-card{
      background:rgba(255,255,255,0.55);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      backdrop-filter: blur(3px);
    }
    body.dark .menu-card{
      background:rgba(15,23,42,0.65);
      box-shadow:none;
      backdrop-filter:none;
    }
    .menu-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .menu-row + .menu-row{ margin-top:10px; }
    .menu-title{ font-weight:900; letter-spacing:.4px; color:var(--text); }
    .menu-sub{ font-size:.82rem; color:var(--muted); font-weight:800; }

    /* Toggle switch */
    .switch{
      position:relative;
      width:54px;
      height:30px;
      flex:0 0 auto;
    }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background:#cbd5e1;
      border-radius:999px;
      transition:.2s;
      border:1px solid rgba(0,0,0,0.06);
    }
    .slider:before{
      content:"";
      position:absolute;
      height:24px; width:24px;
      left:3px; top:2px;
      background:white;
      border-radius:999px;
      transition:.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.18);
    }
    .switch input:checked + .slider{
      background: var(--accent);
    }
    .switch input:checked + .slider:before{
      transform: translateX(24px);
    }
    body.dark .slider{ background:#334155; border-color:#0b1220; }
    body.dark .switch input:checked + .slider{ background: var(--accent); }

    /* Widget clima */
    .weather-box{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.55);
      backdrop-filter: blur(3px);
    }
    body.dark .weather-box{
      background:rgba(15,23,42,0.65);
      backdrop-filter:none;
    }
    .weather-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .weather-city{ font-weight:900; color:var(--text); }
    .weather-meta{ color:var(--muted); font-size:.78rem; font-weight:800; margin-top:2px;}
    .weather-big{ font-size:2.2rem; font-weight:1000; color:var(--text); line-height:1; }
    .weather-desc{ color:var(--muted); font-weight:900; margin-top:4px; font-size:.85rem; }
    .weather-grid{
      display:grid; grid-template-columns:1fr 1fr;
      gap:8px; margin-top:10px;
    }
    .weather-pill{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:rgba(255,255,255,0.65);
      color:var(--text);
      font-weight:900;
      font-size:.86rem;
    }
    body.dark .weather-pill{ background:rgba(2,6,23,0.55); }
    .weather-pill span{ display:block; color:var(--muted); font-size:.72rem; font-weight:900; margin-bottom:2px; text-transform:uppercase; letter-spacing:.6px; }

    .weather-actions{
      display:grid; grid-template-columns:1fr 1fr;
      gap:8px; margin-top:10px;
    }
    .city-search{
      display:flex; gap:8px; align-items:center; margin-top:10px;
    }
    .city-search input{
      margin:0; flex:1;
    }
    .city-search button{
      width:auto; padding:12px 12px; margin:0;
      font-size:.78rem; border-radius:10px;
    }
    .city-results{
      margin-top:8px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      display:none;
    }
    .city-item{
      padding:10px 12px;
      background:rgba(255,255,255,0.75);
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      border-bottom:1px solid var(--border);
    }
    .city-item:last-child{ border-bottom:none; }
    .city-item small{ display:block; color:var(--muted); font-weight:800; margin-top:2px; }
    body.dark .city-item{ background:rgba(2,6,23,0.55); }

    /* Desplegable info √∫til */
    details.info-util{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,0.55);
      backdrop-filter: blur(3px);
    }
    body.dark details.info-util{ background:rgba(15,23,42,0.65); backdrop-filter:none; }

    details.info-util summary{
      list-style:none;
      cursor:pointer;
      padding:12px 14px;
      font-weight:1000;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      user-select:none;
    }
    details.info-util summary::-webkit-details-marker{ display:none; }
    .info-body{ padding:0 14px 12px 14px; }
    .info-line{
      padding:10px 0;
      border-top:1px solid var(--border);
      font-weight:900;
      color:var(--text);
    }
    .info-line span{
      display:block;
      color:var(--muted);
      font-weight:900;
      font-size:.76rem;
      margin-top:2px;
    }

    /* Mensajes existentes */
    #recovery-msg, #finalized-msg{
      margin-top:15px; padding:15px;
      border-left:4px solid;
      border-radius:10px;
      font-size:0.85rem;
      font-weight:800;
      background:rgba(255,255,255,0.55);
      backdrop-filter: blur(3px);
      border:1px solid var(--border);
    }
    body.dark #recovery-msg, body.dark #finalized-msg{ background:rgba(15,23,42,0.65); backdrop-filter:none; }
  </style>
</head>

<body>

<div id="splash" class="splash-screen">
  <div class="splash-icons-cont">
    <svg class="splash-icon splash-cam" viewBox="0 0 24 24"><path d="M20 6h-2.18l-2.14-2.14C15.32 3.5 14.69 3 14 3h-4c-.69 0-1.32.5-1.68.86L6.18 6H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
    <svg class="splash-icon splash-hour" viewBox="0 0 24 24"><path d="M6 2v6l4 4-4 4v6h12v-6l-4-4 4-4V2H6zm10 14.5V18H8v-1.5l4-4 4 4zM12 11.5l-4-4V4h8v3.5l-4 4z"/></svg>
  </div>
  <h1 class="splash-title">SET FOTOGRAFICO</h1>
  <div style="margin-top:10px; color:#666; font-weight:800;">Cargando sistema...</div>
</div>

<div class="card">
  <header class="app-header"><h1>SET FOTOGRAFICO</h1></header>

  <div class="content">
    <div id="s1" class="step active">
      <h2>Men√∫ Principal</h2>

      <!-- Caja ajustes men√∫ -->
      <div class="menu-card">
        <div class="menu-row">
          <div>
            <div class="menu-title">Tema oscuro</div>
            <div class="menu-sub">Solo se cambia desde este men√∫</div>
          </div>
          <label class="switch" title="Tema oscuro">
            <input id="darkToggle" type="checkbox" onchange="toggleDarkFromUI(this.checked)">
            <span class="slider"></span>
          </label>
        </div>

        <button id="btn-continuar" class="btn-sec" style="display:none;" onclick="continuarTrabajo()">CONTINUAR</button>
        <button class="btn-main" onclick="nuevoInforme()">NUEVO</button>
      </div>

      <div id="recovery-msg" style="display:none; border-left-color:#f97316; color:#9a3412;">
        <b>¬°Aviso!</b> Tienes un informe sin terminar guardado en la memoria.
      </div>

      <div id="finalized-msg" style="display:none; border-left-color:#06b6d4; color:#155e75;">
        <b>Informaci√≥n:</b> El √∫ltimo informe fue finalizado y la memoria se limpi√≥ por seguridad.
      </div>

      <!-- Widget clima -->
      <div class="weather-box" id="weatherBox">
        <div class="weather-top">
          <div>
            <div class="weather-city" id="wCity">Osorno</div>
            <div class="weather-meta" id="wMeta">Cargando clima...</div>
          </div>
          <div style="text-align:right;">
            <div class="weather-big" id="wTemp">--¬∞</div>
            <div class="weather-desc" id="wDesc">‚Äî</div>
          </div>
        </div>

        <div class="weather-grid">
          <div class="weather-pill"><span>M√°x / M√≠n</span><div id="wHiLo">-- / --</div></div>
          <div class="weather-pill"><span>Viento</span><div id="wWind">--</div></div>
        </div>

        <div class="city-search">
          <input id="cityInput" type="text" placeholder="Cambiar ciudad (ej: Temuco, Santiago)">
          <button class="btn-sec btn-mini" onclick="buscarCiudad()">BUSCAR</button>
          <button class="btn-ok btn-mini" onclick="refrescarClima()">ACTUALIZAR</button>
        </div>

        <div class="city-results" id="cityResults"></div>
      </div>

      <!-- Informaci√≥n √∫til -->
      <details class="info-util" id="infoUtil">
        <summary>
          <span>INFORMACI√ìN √öTIL</span>
          <span style="color:var(--muted); font-weight:1000;">‚ñº</span>
        </summary>
        <div class="info-body">
          <div class="info-line" id="jplLine">
            JUZGADO DE POLIC√çA LOCAL DE OSORNO DE TURNO: <span id="jplTurno">‚Äî</span>
            <span id="jplRango">‚Äî</span>
          </div>
        </div>
      </details>
    </div>

    <div id="s2" class="step">
      <h2>T√≠tulo del Informe</h2>
      <textarea id="ti_in" rows="4" placeholder="Ej: INSPECCI√ìN T√âCNICA DE..." oninput="saveLocal()"></textarea>
      <button class="btn-main" onclick="guardarTitulo()">Continuar</button>
      <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
    </div>

    <div id="s3" class="step">
      <h2 id="lbl_f">FOTOGRAF√çA 01</h2>

      <label for="f_input" class="btn-label btn-camara">üì∑ TOMAR / GALER√çA</label>
      <input type="file" id="f_input" accept="image/*" onchange="previsualizar()">

      <div id="status"></div>

      <div class="preview-box">
        <h3>Vista previa</h3>
        <img id="previewImg" alt="Vista previa">
        <div class="grid-actions-2">
          <button id="btn-rotL" class="btn-edit btn-mini" onclick="rotarPreview('L')" disabled>GIRAR 90¬∞ IZQ</button>
          <button id="btn-rotR" class="btn-edit btn-mini" onclick="rotarPreview('R')" disabled>GIRAR 90¬∞ DER</button>
        </div>
      </div>

      <textarea id="f_txt" rows="3" placeholder="Descripci√≥n de la imagen..." oninput="saveLocal()"></textarea>

      <button class="btn-main" id="btn-add" onclick="procesarFoto()">Guardar Foto</button>

      <!-- ‚úÖ Finalizar Carga en verde claro (distintivo) -->
      <button class="btn-ok" onclick="cambiarPaso(4)">Finalizar Carga</button>

      <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
    </div>

    <div id="s4" class="step">
      <h2>Datos de Cierre</h2>
      <label>Fecha:</label>
      <input type="date" id="f_date" oninput="saveLocal()">
      <label>Nombre:</label>
      <input type="text" id="f_nom" placeholder="SU NOMBRE COMPLETO" oninput="saveLocal()">
      <label>Cargo:</label>
      <input type="text" id="f_rank" placeholder="SU GRADO O CARGO" oninput="saveLocal()">
      <button class="btn-main" onclick="cambiarPaso(5)">Ir a Revisi√≥n</button>
      <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
    </div>

    <div id="s5" class="step">
      <h2>Revisi√≥n Final</h2>

      <div class="review-box">
        <label>T√≠tulo del informe</label>
        <textarea id="ti_in_review" rows="3" placeholder="Ingrese / edite el t√≠tulo..." oninput="actualizarTituloDesdeRevision(this.value)"></textarea>
      </div>

      <!-- ‚úÖ Mostrar datos de cierre en revisi√≥n, con NOMBRE en MAY√öSCULAS visual -->
      <div class="review-box">
        <label>Datos de cierre</label>
        <label style="margin-top:6px; font-size:.76rem;">Fecha</label>
        <input type="date" id="f_date_review" oninput="syncCierreDesdeRevision()">
        <label style="margin-top:6px; font-size:.76rem;">Nombre (se mostrar√° en MAY√öSCULAS)</label>
        <input type="text" id="f_nom_review" placeholder="SU NOMBRE COMPLETO" oninput="syncCierreDesdeRevision(true)">
        <label style="margin-top:6px; font-size:.76rem;">Cargo</label>
        <input type="text" id="f_rank_review" placeholder="SU GRADO O CARGO" oninput="syncCierreDesdeRevision()">
      </div>

      <div class="hint">En cada foto puedes: girar (izq/der) o cambiar el orden (subir/bajar).</div>
      <div id="render_area"></div>

      <label style="color:#ef4444; font-weight:1000; display:block; margin-top:15px;">NOTA FINAL:</label>
      <textarea id="final_conclusion" rows="3" oninput="saveLocal()"></textarea>

      <div id="pdfHint" class="hint" style="margin-top:10px;"></div>

      <button id="btn-pdf" class="btn-main" style="background:var(--accent); margin-top:18px;" onclick="generarPDF()">GENERAR PDF FINAL</button>
      <button class="btn-sec" onclick="cambiarPaso(3)">+ Agregar m√°s fotos</button>
      <button class="btn-danger" onclick="borrarTodo()">üóëÔ∏è Borrar Todo y Empezar</button>
      <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
    </div>
  </div>

  <footer class="app-footer">
    CREADA POR HERNAN DIAZ
    <div class="footer-sub" id="footerBuild">V19.0 (BETA) ‚Ä¢ BUILD: 2026-01-14</div>
  </footer>
</div>

<script>
  /***********************
   * CONFIG
   ***********************/
  const STORAGE_KEY = 'set_foto_v19';
  const FINALIZED_FLAG = 'set_foto_v19_finalized';

  const DB_NAME = 'set_foto_db_v1';
  const DB_VERSION = 1;
  const STORE_PHOTOS = 'photos';

  // Tema oscuro (solo men√∫ principal)
  const THEME_KEY = 'set_foto_theme';
  // Clima
  const CITY_KEY = 'set_foto_city_v1';

  // Footer build/version (build fijo: c√°mbialo cuando publiques)
  const APP_VERSION = 'V19.0 (BETA)';
  const BUILD_DATE = '2026-01-14';

  // JPL de turno: base definida por usuario (semana con 2DO JPL)
  // Lunes 12-01-2026 00:00 (semana base) = 2DO JPL
  const JPL_BASE_MONDAY_UTC = Date.UTC(2026, 0, 12);

  let photos = [];
  let preview = { blob: null, url: null };

  function uuid(){ return 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 9); }
  function revokeAllUrls(){ photos.forEach(p => { if (p.url) URL.revokeObjectURL(p.url); }); }

  function clearPreview(){
    if (preview.url) URL.revokeObjectURL(preview.url);
    preview = { blob: null, url: null };
    const img = document.getElementById('previewImg');
    img.style.display = 'none';
    img.src = '';
    document.getElementById('btn-rotL').disabled = true;
    document.getElementById('btn-rotR').disabled = true;
  }
  function showPreviewFromBlob(blob){
    clearPreview();
    preview.blob = blob;
    preview.url = URL.createObjectURL(blob);
    const img = document.getElementById('previewImg');
    img.src = preview.url;
    img.style.display = 'block';
    document.getElementById('btn-rotL').disabled = false;
    document.getElementById('btn-rotR').disabled = false;
  }
  function blobToDataURL(blob){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(blob);
    });
  }

  /***********************
   * IndexedDB
   ***********************/
  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE_PHOTOS)){
          db.createObjectStore(STORE_PHOTOS, { keyPath: 'id' });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbPutPhoto(id, blob){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_PHOTOS, 'readwrite');
      tx.objectStore(STORE_PHOTOS).put({ id, blob });
      tx.oncomplete = () => { db.close(); resolve(true); };
      tx.onerror = () => { db.close(); reject(tx.error); };
    });
  }
  async function idbGetPhoto(id){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_PHOTOS, 'readonly');
      const req = tx.objectStore(STORE_PHOTOS).get(id);
      req.onsuccess = () => { db.close(); resolve(req.result ? req.result.blob : null); };
      req.onerror = () => { db.close(); reject(req.error); };
    });
  }
  async function idbDeletePhoto(id){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_PHOTOS, 'readwrite');
      tx.objectStore(STORE_PHOTOS).delete(id);
      tx.oncomplete = () => { db.close(); resolve(true); };
      tx.onerror = () => { db.close(); reject(tx.error); };
    });
  }
  async function idbClearAll(){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_PHOTOS, 'readwrite');
      tx.objectStore(STORE_PHOTOS).clear();
      tx.oncomplete = () => { db.close(); resolve(true); };
      tx.onerror = () => { db.close(); reject(tx.error); };
    });
  }

  /***********************
   * THEME (dark mode)
   ***********************/
  function applyTheme(isDark){
    document.body.classList.toggle('dark', !!isDark);
    const tg = document.getElementById('darkToggle');
    if (tg) tg.checked = !!isDark;
  }
  function loadTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    applyTheme(saved === 'dark');
  }
  function toggleDarkFromUI(isDark){
    localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
    applyTheme(isDark);
  }

  /***********************
   * STARTUP
   ***********************/
  window.onload = () => {
    // Footer build/version
    const f = document.getElementById('footerBuild');
    if (f) f.textContent = `${APP_VERSION} ‚Ä¢ BUILD: ${BUILD_DATE}`;

    loadTheme();

    setTimeout(() => { document.getElementById('splash').classList.add('hidden'); }, 2000);

    arrancarSeguridadYMenu().then(() => {
      // JPL
      actualizarJPLTurno();
      // Clima
      initClima();
    });
  };

  async function arrancarSeguridadYMenu(){
    const finalized = localStorage.getItem(FINALIZED_FLAG);

    if (finalized === '1') {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(FINALIZED_FLAG);

      revokeAllUrls();
      photos = [];
      await idbClearAll();

      document.getElementById('ti_in').value = "";
      document.getElementById('f_date').value = new Date().toISOString().split('T')[0];
      document.getElementById('f_nom').value = "";
      document.getElementById('f_rank').value = "";
      document.getElementById('final_conclusion').value = "";

      document.getElementById('finalized-msg').style.display = 'block';
    } else {
      document.getElementById('finalized-msg').style.display = 'none';
    }

    await loadLocal();
    actualizarMenuPrincipal();
  }

  function actualizarMenuPrincipal(){
    const saved = localStorage.getItem(STORAGE_KEY);
    let hasWork = false;

    if (saved) {
      try {
        const data = JSON.parse(saved);
        const titleOk = (data.title || "").trim().length > 0;
        const photosOk = Array.isArray(data.photos) && data.photos.length > 0;
        const anyFieldOk = ((data.name||"").trim() || (data.rank||"").trim() || (data.conclusion||"").trim());
        hasWork = titleOk || photosOk || anyFieldOk;
      } catch (e) { hasWork = false; }
    }

    document.getElementById('btn-continuar').style.display = hasWork ? 'block' : 'none';
    document.getElementById('recovery-msg').style.display = hasWork ? 'block' : 'none';
  }

  function continuarTrabajo(){
    const title = (document.getElementById('ti_in').value || "").trim();
    if (photos.length > 0) cambiarPaso(5);
    else if (title) cambiarPaso(3);
    else cambiarPaso(2);
  }

  async function nuevoInforme(){
    if (confirm("¬øComenzar un informe NUEVO? Esto borrar√° el trabajo guardado.")) {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(FINALIZED_FLAG);

      revokeAllUrls();
      photos = [];
      await idbClearAll();
      clearPreview();

      document.getElementById('ti_in').value = "";
      document.getElementById('f_date').value = new Date().toISOString().split('T')[0];
      document.getElementById('f_nom').value = "";
      document.getElementById('f_rank').value = "";
      document.getElementById('final_conclusion').value = "";

      actualizarMenuPrincipal();
      cambiarPaso(2);
    }
  }

  function saveLocal(){
    const data = {
      title: document.getElementById('ti_in').value,
      photos: photos.map(p => ({ id: p.id, d: p.d, hRatio: p.hRatio })),
      date: document.getElementById('f_date').value,
      name: document.getElementById('f_nom').value,
      rank: document.getElementById('f_rank').value,
      conclusion: document.getElementById('final_conclusion').value
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    actualizarMenuPrincipal();
  }

  async function loadLocal(){
    const saved = localStorage.getItem(STORAGE_KEY);
    revokeAllUrls();
    photos = [];

    if (saved) {
      const data = JSON.parse(saved);
      document.getElementById('ti_in').value = data.title || "";
      document.getElementById('f_date').value = data.date || new Date().toISOString().split('T')[0];
      document.getElementById('f_nom').value = data.name || "";
      document.getElementById('f_rank').value = data.rank || "";
      document.getElementById('final_conclusion').value = data.conclusion || "";

      const meta = Array.isArray(data.photos) ? data.photos : [];
      for (const m of meta) {
        const blob = await idbGetPhoto(m.id);
        if (blob) {
          const url = URL.createObjectURL(blob);
          photos.push({ id: m.id, url, d: m.d || "", hRatio: Number(m.hRatio) || 1 });
        }
      }
    } else {
      document.getElementById('f_date').value = new Date().toISOString().split('T')[0];
    }
  }

  async function borrarTodo(){
    if(confirm("¬øEst√°s seguro de borrar todo? No se podr√° recuperar.")) {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(FINALIZED_FLAG);

      revokeAllUrls();
      photos = [];
      await idbClearAll();
      clearPreview();

      location.reload();
    }
  }

  function cambiarPaso(n){
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('s' + n).classList.add('active');

    if (n === 3) {
      document.getElementById('lbl_f').innerText = "FOTOGRAF√çA " + (photos.length + 1).toString().padStart(2, '0');
      document.getElementById('status').innerText = "";
    }

    if (n === 5) {
      document.getElementById('ti_in_review').value = document.getElementById('ti_in').value || "";

      // ‚úÖ llevar datos de cierre a revisi√≥n
      document.getElementById('f_date_review').value = document.getElementById('f_date').value || "";
      document.getElementById('f_nom_review').value = (document.getElementById('f_nom').value || "").toUpperCase();
      document.getElementById('f_rank_review').value = document.getElementById('f_rank').value || "";

      dibujarRevision();
      actualizarEstadoPDF();
    }

    document.querySelector('.content').scrollTo(0,0);
    if (n === 1) actualizarMenuPrincipal();
  }

  function guardarTitulo(){
    if(!document.getElementById('ti_in').value.trim()) return alert("Por favor ingrese un t√≠tulo.");
    saveLocal();
    cambiarPaso(3);
  }

  function actualizarTituloDesdeRevision(val){
    document.getElementById('ti_in').value = val;
    saveLocal();
  }

  function syncCierreDesdeRevision(forceUpperName=false){
    const d = document.getElementById('f_date_review').value || "";
    const r = document.getElementById('f_rank_review').value || "";
    let n = document.getElementById('f_nom_review').value || "";

    // ‚úÖ Mostrar en revisi√≥n siempre en may√∫sculas (visual)
    n = n.toUpperCase();
    if (forceUpperName) document.getElementById('f_nom_review').value = n;

    // Guardamos el mismo contenido en el campo real (puedes decidir si quieres guardar may√∫sculas o mantener original;
    // aqu√≠ guardamos may√∫sculas para estandar institucional)
    document.getElementById('f_date').value = d;
    document.getElementById('f_rank').value = r;
    document.getElementById('f_nom').value = n;

    saveLocal();
  }

  /***********************
   * Foto: preview / rotate / save
   ***********************/
  async function previsualizar(){
    const input = document.getElementById('f_input');
    if(!(input.files && input.files[0])) {
      document.getElementById('status').innerText = "";
      clearPreview();
      return;
    }

    const file = input.files[0];
    document.getElementById('status').innerText = "Imagen seleccionada: " + file.name;

    try {
      const arrayBuffer = await file.arrayBuffer();
      const blob = new Blob([arrayBuffer], { type: file.type || "image/jpeg" });

      const url = URL.createObjectURL(blob);
      const img = new Image();

      img.onload = async () => {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          const MAX = 1200;
          let w = img.width, h = img.height;
          if (w > MAX) { h = (h * MAX) / w; w = MAX; }

          canvas.width = w; canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);

          const outBlob = await new Promise((resolve) => {
            canvas.toBlob((b) => resolve(b), "image/jpeg", 0.75);
          });

          showPreviewFromBlob(outBlob);

        } catch (err) {
          console.error(err);
          alert("Error creando vista previa.");
          clearPreview();
        } finally { URL.revokeObjectURL(url); }
      };

      img.onerror = () => { URL.revokeObjectURL(url); alert("No se pudo cargar la imagen."); clearPreview(); };
      img.src = url;

    } catch (e) {
      console.error(e);
      alert("Error al leer la imagen.");
      clearPreview();
    }
  }

  async function rotarPreview(dir){
    try {
      if (!preview.blob) return;

      const url = URL.createObjectURL(preview.blob);
      const img = new Image();

      img.onload = async () => {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          canvas.width = img.height;
          canvas.height = img.width;

          if (dir === 'R') { ctx.translate(canvas.width, 0); ctx.rotate(Math.PI/2); }
          else { ctx.translate(0, canvas.height); ctx.rotate(-Math.PI/2); }

          ctx.drawImage(img, 0, 0);

          const outBlob = await new Promise((resolve) => {
            canvas.toBlob((b) => resolve(b), "image/jpeg", 0.8);
          });

          showPreviewFromBlob(outBlob);

        } catch (err) {
          console.error(err);
          alert("No se pudo rotar la vista previa.");
        } finally { URL.revokeObjectURL(url); }
      };

      img.onerror = () => { URL.revokeObjectURL(url); alert("No se pudo cargar la imagen para rotar."); };
      img.src = url;

    } catch (e) {
      console.error(e);
      alert("Error al rotar la vista previa.");
    }
  }

  async function procesarFoto(){
    const input = document.getElementById('f_input');
    if(!preview.blob) return alert("Debe seleccionar una foto primero (y ver la miniatura).");

    document.getElementById('btn-add').disabled = true;
    document.getElementById('status').innerText = "Guardando imagen...";

    try {
      const outBlob = preview.blob;

      const id = uuid();
      await idbPutPhoto(id, outBlob);

      const previewUrl = URL.createObjectURL(outBlob);

      const tmpUrl = URL.createObjectURL(outBlob);
      const img = new Image();
      await new Promise((resolve, reject) => {
        img.onload = () => resolve(true);
        img.onerror = reject;
        img.src = tmpUrl;
      });
      const hRatio = img.height / img.width;
      URL.revokeObjectURL(tmpUrl);

      photos.push({ id, url: previewUrl, d: document.getElementById('f_txt').value, hRatio });

      input.value = "";
      document.getElementById('f_txt').value = "";
      clearPreview();

      document.getElementById('btn-add').disabled = false;
      document.getElementById('status').innerText = "¬°Guardada correctamente!";
      saveLocal();

      setTimeout(() => { cambiarPaso(3); }, 250);

    } catch(e) {
      console.error(e);
      alert("Error al guardar la foto.");
      document.getElementById('btn-add').disabled = false;
      document.getElementById('status').innerText = "";
    }
  }

  async function eliminarFoto(index){
    if(confirm("¬øEliminar esta foto?")) {
      const p = photos[index];
      if (p?.url) URL.revokeObjectURL(p.url);

      photos.splice(index, 1);
      saveLocal();
      dibujarRevision();
      actualizarEstadoPDF();

      if (p?.id) { try { await idbDeletePhoto(p.id); } catch(_) {} }
    }
  }
  function actualizarDesc(index, val){
    photos[index].d = val;
    saveLocal();
    actualizarEstadoPDF();
  }

  function moverFoto(index, dir){
    const newIndex = index + dir;
    if (newIndex < 0 || newIndex >= photos.length) return;
    const tmp = photos[index];
    photos[index] = photos[newIndex];
    photos[newIndex] = tmp;
    saveLocal();
    dibujarRevision();
    actualizarEstadoPDF();
  }

  async function rotarFoto(index, dir){
    try {
      const p = photos[index];
      if (!p) return;

      const blob = await idbGetPhoto(p.id);
      if (!blob) return alert("No se encontr√≥ la imagen en la base local.");

      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = async () => {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          canvas.width = img.height;
          canvas.height = img.width;

          if (dir === 'R') { ctx.translate(canvas.width, 0); ctx.rotate(Math.PI/2); }
          else { ctx.translate(0, canvas.height); ctx.rotate(-Math.PI/2); }

          ctx.drawImage(img, 0, 0);

          const outBlob = await new Promise((resolve) => {
            canvas.toBlob((b) => resolve(b), "image/jpeg", 0.8);
          });

          await idbPutPhoto(p.id, outBlob);

          if (p.url) URL.revokeObjectURL(p.url);
          p.url = URL.createObjectURL(outBlob);
          p.hRatio = canvas.height / canvas.width;

          saveLocal();
          dibujarRevision();

        } catch (err) {
          console.error(err);
          alert("No se pudo rotar la foto.");
        } finally { URL.revokeObjectURL(url); }
      };
      img.onerror = () => { URL.revokeObjectURL(url); alert("No se pudo cargar la imagen para rotar."); };
      img.src = url;

    } catch (e) {
      console.error(e);
      alert("Error al rotar la foto.");
    }
  }

  function dibujarRevision(){
    const area = document.getElementById('render_area');
    area.innerHTML = "";
    if(photos.length === 0) area.innerHTML = "<p style='text-align:center; font-weight:900; color:var(--muted)'>No hay fotos cargadas.</p>";

    photos.forEach((p, i) => {
      const div = document.createElement('div');
      div.className = 'item-foto';

      const upDisabled = (i === 0) ? 'disabled' : '';
      const downDisabled = (i === photos.length - 1) ? 'disabled' : '';

      div.innerHTML = `
        <div class="item-header">
          <span>FOTO ${(i+1).toString().padStart(2, '0')}</span>
          <span class="btn-delete" onclick="eliminarFoto(${i})">ELIMINAR ‚úï</span>
        </div>

        <img src="${p.url}" style="width:100%; border-radius:10px; border:1px solid var(--border); margin-bottom:8px; background:var(--card);">

        <textarea placeholder="Descripci√≥n..." onchange="actualizarDesc(${i}, this.value)">${p.d || ""}</textarea>

        <div class="grid-actions-4">
          <button class="btn-edit btn-mini" onclick="rotarFoto(${i}, 'L')">GIRAR 90¬∞ IZQ</button>
          <button class="btn-edit btn-mini" onclick="rotarFoto(${i}, 'R')">GIRAR 90¬∞ DER</button>
          <button class="btn-main btn-mini" ${upDisabled} onclick="moverFoto(${i}, -1)">SUBIR</button>
          <button class="btn-main btn-mini" ${downDisabled} onclick="moverFoto(${i}, 1)">BAJAR</button>
        </div>
      `;
      area.appendChild(div);
    });
  }

  /***********************
   * Validaci√≥n PDF: todas las fotos con descripci√≥n
   ***********************/
  function normalizeText(s){ return (s || "").replace(/\u00A0/g, " ").trim(); }

  function fotosSinDescripcion(){
    return photos.some(p => !normalizeText(p.d || ""));
  }

  function actualizarEstadoPDF(){
    const btn = document.getElementById('btn-pdf');
    const hint = document.getElementById('pdfHint');
    if (!btn || !hint) return;

    if (photos.length === 0){
      btn.disabled = true;
      hint.textContent = "Debes cargar al menos 1 fotograf√≠a.";
      return;
    }

    if (fotosSinDescripcion()){
      btn.disabled = true;
      hint.textContent = "Existen fotograf√≠as sin descripci√≥n. Completa todas para generar el PDF.";
      return;
    }

    btn.disabled = false;
    hint.textContent = "";
  }

  /***********************
   * PDF: Justificaci√≥n cuadrada + primera l√≠nea alineada al margen derecho igual que el resto
   ***********************/
  function splitLongTokenByWidth(doc, token, maxWidth){
    const out = [];
    let chunk = "";
    for (const ch of token) {
      const test = chunk + ch;
      if (doc.getTextWidth(test) <= maxWidth) chunk = test;
      else { if (chunk) out.push(chunk); chunk = ch; }
    }
    if (chunk) out.push(chunk);
    return out;
  }

  function wordsSafe(doc, text, maxWidth){
    const raw = normalizeText(text).replace(/\s+/g, " ");
    if (!raw) return [];
    const tokens = raw.split(" ");
    const out = [];
    for (const tok of tokens) {
      if (!tok) continue;
      if (doc.getTextWidth(tok) <= maxWidth) out.push(tok);
      else out.push(...splitLongTokenByWidth(doc, tok, maxWidth));
    }
    return out;
  }

  function drawJustifiedMixedSegments(doc, segments, x, y, width){
    if (!segments || segments.length === 0) return;

    if (segments.length === 1) {
      doc.setFont("helvetica", segments[0].font);
      doc.text(segments[0].text, x, y);
      return;
    }

    let totalW = 0;
    const widths = [];
    for (const seg of segments) {
      doc.setFont("helvetica", seg.font);
      const w = doc.getTextWidth(seg.text);
      widths.push(w);
      totalW += w;
    }

    const gaps = segments.length - 1;
    if (totalW >= width || gaps <= 0) {
      let cx = x;
      for (let i = 0; i < segments.length; i++) {
        doc.setFont("helvetica", segments[i].font);
        doc.text(segments[i].text, cx, y);
        cx += widths[i];
        if (i < segments.length - 1) {
          doc.setFont("helvetica", "normal");
          const sp = doc.getTextWidth(" ");
          cx += sp;
        }
      }
      return;
    }

    const gapSize = (width - totalW) / gaps;

    let cx = x;
    for (let i = 0; i < segments.length; i++) {
      doc.setFont("helvetica", segments[i].font);
      doc.text(segments[i].text, cx, y);
      cx += widths[i];
      if (i < segments.length - 1) cx += gapSize;
    }
  }

  function buildFirstLineWithLabel(doc, label, words, width){
    const line = [];
    doc.setFont("helvetica", "bold");
    let currentW = doc.getTextWidth(label);

    doc.setFont("helvetica", "normal");
    const minSpace = doc.getTextWidth(" ");
    currentW += minSpace;

    for (const w of words) {
      const test = line.length ? (currentW + doc.getTextWidth(w) + minSpace) : (currentW + doc.getTextWidth(w));
      if (test <= width) {
        line.push(w);
        currentW = test;
      } else break;
    }
    return line;
  }

  function buildLines(doc, words, width){
    const lines = [];
    let line = [];
    for (const w of words) {
      const testLine = line.length ? [...line, w] : [w];
      const testText = testLine.join(" ");
      if (doc.getTextWidth(testText) <= width) line = testLine;
      else { if (line.length) lines.push(line); line = [w]; }
    }
    if (line.length) lines.push(line);
    return lines;
  }

  function drawJustifiedWords(doc, words, x, y, width){
    if (!words || words.length === 0) return;
    if (words.length === 1) { doc.text(words[0], x, y); return; }

    const wordsWidth = words.reduce((sum, w) => sum + doc.getTextWidth(w), 0);
    const gaps = words.length - 1;
    if (wordsWidth >= width || gaps <= 0) { doc.text(words.join(" "), x, y); return; }

    const gapSize = (width - wordsWidth) / gaps;
    let cursorX = x;
    for (let i = 0; i < words.length; i++) {
      doc.text(words[i], cursorX, y);
      cursorX += doc.getTextWidth(words[i]);
      if (i < words.length - 1) cursorX += gapSize;
    }
  }

  function printTitleUnderlinedSafe(doc, titleText, pW, usefulW, state, pageBreakFn){
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(0);

    const words = wordsSafe(doc, titleText, usefulW);
    const lines = buildLines(doc, words, usefulW).map(arr => arr.join(" "));

    for (const line of lines) {
      if (state.y > 275) pageBreakFn();

      const tw = doc.getTextWidth(line);
      const tx = (pW - tw) / 2;

      doc.text(line, pW / 2, state.y, { align: 'center' });
      doc.setLineWidth(0.5);
      doc.line(tx, state.y + 1.2, tx + tw, state.y + 1.2);

      state.y += 7;
    }
    state.y += 8;
  }

  function imprimirEtiquetaEnMismaLinea_CuadradoTotal(doc, etiqueta, texto, x, width, lineHeight, state, pageBreakFn, color=null){
    const t = normalizeText(texto);
    if (!t) return;

    const setColor = () => {
      if (color) doc.setTextColor(color[0], color[1], color[2]);
      else doc.setTextColor(0);
    };

    const label = (etiqueta || "").trim();
    doc.setFont("helvetica", "normal");
    setColor();
    const allWords = wordsSafe(doc, t, width);

    const firstLineWords = buildFirstLineWithLabel(doc, label, allWords, width);
    const remainingWords = allWords.slice(firstLineWords.length);
    const restLines = buildLines(doc, remainingWords, width);

    if (state.y > 275) pageBreakFn();

    const segments = [{ text: label, font: "bold" }, ...firstLineWords.map(w => ({ text: w, font: "normal" }))];

    setColor();
    if (restLines.length > 0) {
      drawJustifiedMixedSegments(doc, segments, x, state.y, width);
    } else {
      let cx = x;
      doc.setFont("helvetica", "bold"); doc.text(label, cx, state.y); cx += doc.getTextWidth(label);
      doc.setFont("helvetica", "normal"); doc.text(" " + firstLineWords.join(" "), cx, state.y);
    }

    state.y += lineHeight;

    doc.setFont("helvetica", "normal");
    for (let i = 0; i < restLines.length; i++) {
      if (state.y > 275) pageBreakFn();
      const isLast = (i === restLines.length - 1);
      if (!isLast) drawJustifiedWords(doc, restLines[i], x, state.y, width);
      else doc.text(restLines[i].join(" "), x, state.y);
      state.y += lineHeight;
    }

    state.y += 3;
    doc.setTextColor(0);
  }

  async function generarPDF(){
    // ‚úÖ bloqueo: todas las fotos deben tener descripci√≥n
    if (fotosSinDescripcion()){
      alert("existen fotografias sin descripcion");
      actualizarEstadoPDF();
      return;
    }

    const btn = document.getElementById('btn-pdf');
    btn.innerText = "GENERANDO..."; btn.disabled = true;

    try {
      await new Promise(r => setTimeout(r, 100));
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const pW = doc.internal.pageSize.getWidth();
      const pMargin = 25;
      const usefulW = pW - (pMargin * 2);

      const state = { y: 30 };
      const pageBreakFn = () => { doc.addPage(); state.y = 30; };

      // T√çTULO
      const title = (document.getElementById('ti_in').value || "").toUpperCase();
      printTitleUnderlinedSafe(doc, title, pW, usefulW, state, pageBreakFn);

      // FOTOS
      const maxImgH = 75;
      doc.setFontSize(12);

      for (let i = 0; i < photos.length; i++) {
        const p = photos[i];
        const blob = await idbGetPhoto(p.id);
        if (!blob) continue;

        const dataUrl = await blobToDataURL(blob);

        let imgH = maxImgH;
        let imgW = imgH / p.hRatio;
        if (imgW > usefulW) { imgW = usefulW; imgH = imgW * p.hRatio; }

        if (state.y + imgH + 25 > 275) pageBreakFn();

        const xImg = (pW - imgW) / 2;
        doc.addImage(dataUrl, 'JPEG', xImg, state.y, imgW, imgH);

        doc.setDrawColor(0); doc.setLineWidth(0.3);
        doc.rect(xImg, state.y, imgW, imgH);

        state.y += imgH + 8;

        imprimirEtiquetaEnMismaLinea_CuadradoTotal(
          doc,
          `FOTOGRAF√çA ${(i+1).toString().padStart(2,'0')}:`,
          (p.d || ""),
          pMargin,
          usefulW,
          5,
          state,
          pageBreakFn
        );

        state.y += 2;
      }

      // NOTA FINAL (rojo)
      const conclusion = document.getElementById('final_conclusion').value;
      if (conclusion && conclusion.trim()) {
        if (state.y + 20 > 275) pageBreakFn();

        imprimirEtiquetaEnMismaLinea_CuadradoTotal(
          doc,
          "NOTA:",
          conclusion,
          pMargin,
          usefulW,
          5,
          state,
          pageBreakFn,
          [220, 38, 38]
        );
      }

      // FIRMA
      if (state.y + 35 > 275) pageBreakFn(); else state.y += 10;

      doc.setFontSize(12); doc.setTextColor(0); doc.setFont("helvetica", "normal");
      doc.text("FECHA: " + document.getElementById('f_date').value, pW - pMargin, state.y, {align:'right'});

      state.y += 20;
      doc.setFont("helvetica", "bold");
      // ‚úÖ NOMBRE EN MAY√öSCULAS
      doc.text((document.getElementById('f_nom').value || "").toUpperCase(), pW/2, state.y, {align:'center'});

      state.y += 5;
      doc.setFont("helvetica", "normal");
      doc.text((document.getElementById('f_rank').value || "").toUpperCase(), pW/2, state.y, {align:'center'});

      // PAGINAS
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(0);
        doc.text(`P√°gina ${i} de ${totalPages}`, pW - pMargin, 10, {align:'right'});
      }

      doc.save("Reporte_Fotografico.pdf");
      localStorage.setItem(FINALIZED_FLAG, '1');

    } catch (e) {
      console.error(e);
      alert("Error al generar el PDF. Intente con menos fotos o fotos m√°s ligeras.");
    } finally {
      btn.innerText = "GENERAR PDF FINAL";
      btn.disabled = false;
      actualizarEstadoPDF();
    }
  }

  /***********************
   * CLIMA (Open-Meteo)
   ***********************/
  function weatherCodeToText(code){
    // Resumen amigable (no exhaustivo)
    const m = {
      0:"Despejado",
      1:"Mayormente despejado",
      2:"Parcialmente nublado",
      3:"Nublado",
      45:"Niebla",
      48:"Niebla (hielo)",
      51:"Llovizna leve",
      53:"Llovizna",
      55:"Llovizna intensa",
      61:"Lluvia leve",
      63:"Lluvia",
      65:"Lluvia intensa",
      71:"Nieve leve",
      73:"Nieve",
      75:"Nieve intensa",
      80:"Chubascos leves",
      81:"Chubascos",
      82:"Chubascos intensos",
      95:"Tormenta",
      96:"Tormenta con granizo",
      99:"Tormenta con granizo (fuerte)"
    };
    return m[code] || "Condici√≥n variable";
  }

  function loadSavedCity(){
    try{
      const raw = localStorage.getItem(CITY_KEY);
      if (!raw) return { name:"Osorno", lat:-40.5739, lon:-73.1335 }; // fallback aproximado
      const data = JSON.parse(raw);
      if (data && data.name && typeof data.lat === "number" && typeof data.lon === "number") return data;
    }catch(_){}
    return { name:"Osorno", lat:-40.5739, lon:-73.1335 };
  }

  function saveCity(city){
    localStorage.setItem(CITY_KEY, JSON.stringify(city));
  }

  async function initClima(){
    const city = loadSavedCity();
    document.getElementById('wCity').textContent = city.name;
    await fetchClima(city.lat, city.lon, city.name);
  }

  async function refrescarClima(){
    const city = loadSavedCity();
    await fetchClima(city.lat, city.lon, city.name);
  }

  async function fetchClima(lat, lon, name){
    const wMeta = document.getElementById('wMeta');
    const wTemp = document.getElementById('wTemp');
    const wDesc = document.getElementById('wDesc');
    const wHiLo = document.getElementById('wHiLo');
    const wWind = document.getElementById('wWind');
    const wCity = document.getElementById('wCity');

    wCity.textContent = name;
    wMeta.textContent = "Cargando clima...";
    wTemp.textContent = "--¬∞";
    wDesc.textContent = "‚Äî";
    wHiLo.textContent = "-- / --";
    wWind.textContent = "--";

    try{
      const url =
        "https://api.open-meteo.com/v1/forecast"
        + `?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}`
        + "&current=temperature_2m,weather_code,wind_speed_10m"
        + "&daily=temperature_2m_max,temperature_2m_min"
        + "&timezone=America%2FSantiago";

      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Weather fetch failed");
      const data = await res.json();

      const temp = data?.current?.temperature_2m;
      const code = data?.current?.weather_code;
      const wind = data?.current?.wind_speed_10m;

      const hi = data?.daily?.temperature_2m_max?.[0];
      const lo = data?.daily?.temperature_2m_min?.[0];

      const nowStr = new Intl.DateTimeFormat('es-CL', {
        timeZone:'America/Santiago',
        hour:'2-digit', minute:'2-digit'
      }).format(new Date());

      wTemp.textContent = (typeof temp === "number") ? `${Math.round(temp)}¬∞` : "--¬∞";
      wDesc.textContent = weatherCodeToText(code);
      wHiLo.textContent = (typeof hi === "number" && typeof lo === "number") ? `${Math.round(hi)}¬∞ / ${Math.round(lo)}¬∞` : "-- / --";
      wWind.textContent = (typeof wind === "number") ? `${Math.round(wind)} km/h` : "--";
      wMeta.textContent = `Actualizado ${nowStr} (America/Santiago)`;
    }catch(e){
      console.error(e);
      wMeta.textContent = "No se pudo cargar clima (sin conexi√≥n o servicio no disponible).";
    }
  }

  async function buscarCiudad(){
    const q = (document.getElementById('cityInput').value || "").trim();
    const box = document.getElementById('cityResults');
    box.innerHTML = "";
    box.style.display = "none";
    if (!q) return;

    try{
      const url =
        "https://geocoding-api.open-meteo.com/v1/search"
        + `?name=${encodeURIComponent(q)}&count=6&language=es&format=json`;

      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Geocoding failed");
      const data = await res.json();
      const results = data?.results || [];
      if (!results.length){
        box.innerHTML = `<div class="city-item">Sin resultados <small>Prueba con otra ciudad.</small></div>`;
        box.style.display = "block";
        return;
      }

      results.forEach(r => {
        const name = r.name;
        const admin1 = r.admin1 || "";
        const country = r.country || "";
        const lat = r.latitude;
        const lon = r.longitude;

        const div = document.createElement('div');
        div.className = 'city-item';
        div.innerHTML = `${name}<small>${admin1 ? admin1 + " ‚Ä¢ " : ""}${country}</small>`;
        div.onclick = async () => {
          const city = { name: `${name}${admin1 ? ", " + admin1 : ""}`, lat, lon };
          saveCity(city);
          document.getElementById('cityInput').value = "";
          box.style.display = "none";
          await fetchClima(lat, lon, city.name);
        };
        box.appendChild(div);
      });
      box.style.display = "block";
    }catch(e){
      console.error(e);
      box.innerHTML = `<div class="city-item">No se pudo buscar <small>Revisa tu conexi√≥n.</small></div>`;
      box.style.display = "block";
    }
  }

  /***********************
   * INFORMACI√ìN √öTIL: JPL de turno (Osorno) - semanal alternado
   * Semana definida por America/Santiago (c√°lculo robusto con Intl)
   ***********************/
  function getSantiagoYMD(){
    const fmt = new Intl.DateTimeFormat('en-CA', { timeZone:'America/Santiago', year:'numeric', month:'2-digit', day:'2-digit' });
    const parts = fmt.formatToParts(new Date());
    const y = Number(parts.find(p=>p.type==='year')?.value);
    const m = Number(parts.find(p=>p.type==='month')?.value);
    const d = Number(parts.find(p=>p.type==='day')?.value);
    return { y, m, d };
  }

  function utcFromYMD({y,m,d}){
    return Date.UTC(y, m-1, d);
  }

  function getMondayUTCOfWeek(utcDate){
    const dt = new Date(utcDate);
    const dow = dt.getUTCDay(); // 0=Dom ... 6=S√°b
    const daysSinceMonday = (dow + 6) % 7; // Lun->0, Mar->1, ... Dom->6
    return utcDate - daysSinceMonday * 86400000;
  }

  function fmtSantiagoDateFromUTC(utcDate){
    // Mostrar rango con formato es-CL
    const dt = new Date(utcDate);
    return new Intl.DateTimeFormat('es-CL', {
      timeZone:'America/Santiago', day:'2-digit', month:'2-digit', year:'numeric'
    }).format(dt);
  }

  function calcularJPLTurno(){
    const ymd = getSantiagoYMD();
    const todayUTC = utcFromYMD(ymd);
    const mondayUTC = getMondayUTCOfWeek(todayUTC);

    const diffWeeks = Math.floor((mondayUTC - JPL_BASE_MONDAY_UTC) / (7 * 86400000));
    const isEven = (diffWeeks % 2 === 0);

    // Semana base (par) = 2DO JPL
    const turno = isEven ? "2DO JPL" : "1ER JPL";

    const sundayUTC = mondayUTC + 6 * 86400000;
    const rango = `Semana: ${fmtSantiagoDateFromUTC(mondayUTC)} al ${fmtSantiagoDateFromUTC(sundayUTC)} (America/Santiago)`;

    return { turno, rango };
  }

  function actualizarJPLTurno(){
    const out = calcularJPLTurno();
    document.getElementById('jplTurno').textContent = out.turno;
    document.getElementById('jplRango').textContent = out.rango;
  }

  // refresco cada 5 minutos por si cambia el d√≠a
  setInterval(() => {
    try { actualizarJPLTurno(); } catch(_) {}
  }, 5 * 60 * 1000);
</script>

</body>
</html>
