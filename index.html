<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SET FOTOGRAFICO BETA 19.3</title>

  <!-- ICONOS: se mantiene tal cual el √∫ltimo c√≥digo (sin cambios) -->
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042339.png" />
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042339.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link rel="manifest" href='data:application/manifest+json,{"name":"SET%20FOTOGRAFICO","short_name":"SET","start_url":".","display":"standalone","background_color":"#f1f5f9","theme_color":"#1e40af","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/1042/1042339.png","sizes":"512x512","type":"image/png"}]}'>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --p:#1e40af; --accent:#059669; --light-green:#2ecc71; --dark-gray:#334155;
      --menu-bg:#dff6e8;
      --card-bg:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;

      --btn-main: var(--p);
      --btn-ok: var(--accent);
      --btn-neutral: #64748b;
      --btn-danger: #ef4444;
      --btn-edit: #f59e0b;
    }
    body.dark{
      --menu-bg:#0b1220;
      --card-bg:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2a44;
      --btn-neutral:#334155;
      --btn-edit:#fbbf24;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:'Segoe UI',sans-serif;
      background:var(--menu-bg);
      margin:0;padding:0;
      display:flex;justify-content:center;
      height:100dvh;overflow:hidden;
      color:var(--text);
    }

    .splash-screen{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,var(--light-green) 0%,#ffffff 100%);
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;transition:opacity .5s ease;
    }
    .splash-screen.hidden{opacity:0;pointer-events:none;}
    .splash-icons-cont{display:flex;align-items:center;gap:15px;margin-bottom:20px;}
    .splash-icon{width:70px;height:70px;}
    .splash-cam{fill:var(--dark-gray);}
    .splash-hour{fill:var(--accent);animation:rotateHour 3s infinite linear;}
    @keyframes rotateHour{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .splash-title{font-size:2rem;color:var(--p);margin:0;font-weight:900;letter-spacing:1px;}

    .card{
      background:transparent;
      width:100%;max-width:520px;height:100%;
      display:flex;flex-direction:column;position:relative;
      box-shadow:0 0 20px rgba(0,0,0,0.10);
    }
    .app-header{
      background:var(--card-bg);
      border-bottom:1px solid var(--border);
      padding:14px 15px;
      text-align:center;
      flex-shrink:0;
      z-index:10;
    }
    .brand{display:flex;align-items:center;justify-content:center;gap:10px;}
    .brand img{width:28px;height:28px;border-radius:6px;}
    .brand .brand-title{
      font-size:1.25rem;margin:0;
      color:var(--p);font-weight:900;
      letter-spacing:.5px;text-transform:uppercase;
    }

    .content{
      padding:18px;
      flex-grow:1;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }

    .app-footer{
      padding:10px 12px;
      text-align:center;
      border-top:1px solid var(--border);
      color:var(--p);
      font-size:.75rem;
      font-weight:800;
      background:rgba(255,255,255,0.55);
      flex-shrink:0;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    body.dark .app-footer{background:rgba(15,23,42,0.75);color:#93c5fd;}

    .step{display:none;animation:fadeIn .3s ease;}
    .step.active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

    h2{
      font-size:1.05rem;color:var(--dark-gray);
      text-align:center;text-transform:uppercase;
      border-bottom:3px solid var(--p);
      padding-bottom:10px;margin-top:0;
    }
    body.dark h2{color:#dbeafe;}

    input[type="text"], input[type="date"], textarea, select{
      width:100%;
      padding:14px;margin:10px 0;
      border:1px solid #cbd5e1;border-radius:10px;
      font-size:16px;
      background:var(--card-bg);
      color:var(--text);
    }
    body.dark input, body.dark textarea, body.dark select{border:1px solid var(--border);}
    textarea{resize:vertical;min-height:80px;}

    /* ‚úÖ Botones SIEMPRE opacos cuando est√°n habilitados */
    button,.btn-label{
      width:100%;
      padding:16px;margin:6px 0;
      border:none;border-radius:10px;
      font-weight:900;cursor:pointer;
      color:white;text-transform:uppercase;
      font-size:1rem;display:block;text-align:center;
      transition:transform .1s;
      opacity:1; /* <- importante */
    }
    button:active,.btn-label:active{transform:scale(.98);}

    .btn-main{background:var(--btn-main);}
    .btn-sec{background:var(--btn-neutral);}
    .btn-ok{background:var(--btn-ok);}
    .btn-danger{background:var(--btn-danger);font-size:.9rem;margin-top:25px;}
    .btn-mini{padding:10px;font-size:.78rem;border-radius:8px;margin:0;}
    .btn-edit{background:var(--btn-edit);}

    /* ‚úÖ Solo lo deshabilitado baja opacidad */
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    input[type="file"]{display:none;}
    .btn-camara{background:var(--btn-main);display:flex;align-items:center;justify-content:center;gap:10px;}

    .item-foto{
      border:1px solid var(--border);
      padding:12px;margin-bottom:15px;border-radius:12px;
      background:var(--card-bg);
      box-shadow:0 2px 5px rgba(0,0,0,0.05);
    }
    .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--p);font-weight:900;font-size:.9rem;}
    .btn-delete{color:#b91c1c;background:#fee2e2;padding:4px 10px;border-radius:5px;cursor:pointer;font-weight:900;}
    #status{color:var(--accent);font-weight:900;text-align:center;margin:10px 0;min-height:20px;}

    .review-box{
      border:1px solid var(--border);
      border-radius:12px;padding:12px;
      background:rgba(255,255,255,0.55);
      margin-bottom:15px;
    }
    body.dark .review-box{background:rgba(15,23,42,0.65);}

    .review-box label{
      font-weight:900;color:var(--dark-gray);
      display:block;margin-bottom:6px;
      text-transform:uppercase;font-size:.8rem;letter-spacing:.5px;
    }
    body.dark .review-box label{color:#dbeafe;}

    .grid-actions-4{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
    .hint{font-size:.78rem;color:var(--muted);margin-top:8px;text-align:center;}

    .preview-box{
      border:1px solid var(--border);
      border-radius:12px;padding:10px;
      background:rgba(255,255,255,0.55);
      margin-top:10px;
    }
    body.dark .preview-box{background:rgba(15,23,42,0.65);}
    .preview-box h3{margin:0 0 8px 0;font-size:.85rem;color:var(--dark-gray);text-transform:uppercase;letter-spacing:.5px;}
    body.dark .preview-box h3{color:#dbeafe;}

    #previewImg{
      width:100%;
      max-height:180px;
      object-fit:contain;
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      display:none;
    }
    .grid-actions-2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}

    .panel{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,0.55);
      padding:12px;
    }
    body.dark .panel{background:rgba(15,23,42,0.65);}

    .panel-title{
      font-weight:900;color:var(--dark-gray);
      text-transform:uppercase;letter-spacing:.5px;
      font-size:.82rem;margin:0 0 8px 0;
    }
    body.dark .panel-title{color:#dbeafe;}

    .weather-row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:12px;padding:10px;
    }
    .w-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .w-icon{width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:22px;}
    .w-meta{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .w-city{font-weight:900;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .w-desc{color:var(--muted);font-size:.8rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .w-right{text-align:right;display:flex;flex-direction:column;gap:2px;flex-shrink:0;}
    .w-temp{font-weight:900;font-size:1.05rem;}
    .w-minmax{color:var(--muted);font-size:.78rem;font-weight:800;}

    .weather-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}

    .acc{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:var(--card-bg);
      margin-top:10px;
    }
    .acc summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--dark-gray);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    body.dark .acc summary{color:#dbeafe;}
    .acc summary::-webkit-details-marker{display:none;}
    .acc .acc-body{
      padding:12px;
      border-top:1px solid var(--border);
      color:var(--text);
      font-weight:800;
      font-size:.92rem;
    }
    .acc .info-line{padding:8px 0;border-bottom:1px dashed rgba(100,116,139,0.35);}
    .acc .info-line:last-child{border-bottom:none;}

    .small-note{
      color:var(--muted);
      font-weight:700;
      font-size:.78rem;
      margin-top:6px;
    }

    .switch-row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,0.55);
    }
    body.dark .switch-row{background:rgba(15,23,42,0.65);}
    .switch-row .sw-label{
      font-weight:900;text-transform:uppercase;letter-spacing:.5px;
      font-size:.82rem;color:var(--dark-gray);
    }
    body.dark .switch-row .sw-label{color:#dbeafe;}

    .switch{
      position:relative;width:54px;height:30px;
      background:#cbd5e1;border-radius:999px;cursor:pointer;flex-shrink:0;
      border:1px solid rgba(0,0,0,0.08);
    }
    body.dark .switch{background:#334155;border:1px solid rgba(255,255,255,0.10);}
    .knob{
      position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;
      background:white;transition:all .2s ease;box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }
    .switch.on{background:#22c55e;}
    .switch.on .knob{left:27px;}

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      padding:18px;
    }
    .modal{
      width:100%;
      max-width:420px;
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,0.35);
    }
    .modal h3{
      margin:0 0 6px 0;
      font-size:1rem;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--dark-gray);
    }
    body.dark .modal h3{color:#dbeafe;}
    .modal p{
      margin:0 0 10px 0;
      color:var(--muted);
      font-weight:700;
      font-size:.9rem;
      line-height:1.25rem;
    }
    .modal .modal-actions{display:grid;grid-template-columns:1fr;gap:8px;}

    /* ‚úÖ Bot√≥n de PDF apagado SOLO cuando falta descripci√≥n */
    .pdf-disabled-hint{
      color:var(--muted);
      font-weight:700;
      font-size:.78rem;
      text-align:center;
      margin-top:6px;
      display:none;
    }
  </style>
</head>

<body>
  <div id="splash" class="splash-screen">
    <div class="splash-icons-cont">
      <svg class="splash-icon splash-cam" viewBox="0 0 24 24">
        <path d="M20 6h-2.18l-2.14-2.14C15.32 3.5 14.69 3 14 3h-4c-.69 0-1.32.5-1.68.86L6.18 6H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
      </svg>
      <svg class="splash-icon splash-hour" viewBox="0 0 24 24">
        <path d="M6 2v6l4 4-4 4v6h12v-6l-4-4 4-4V2H6zm10 14.5V18H8v-1.5l4-4 4 4zM12 11.5l-4-4V4h8v3.5l-4 4z"/>
      </svg>
    </div>
    <h1 class="splash-title">SET FOTOGRAFICO</h1>
    <div style="margin-top:10px; color:#666;">Cargando sistema...</div>
  </div>

  <div class="card">
    <header class="app-header">
      <div class="brand">
        <img id="headerLogo" src="https://cdn-icons-png.flaticon.com/512/1042/1042339.png" alt="Logo">
        <div class="brand-title">SET FOTOGRAFICO</div>
      </div>
    </header>

    <div class="content">
      <div id="s1" class="step active">
        <h2>Men√∫ Principal</h2>

        <button id="btn-continuar" class="btn-sec" style="display:none;" onclick="continuarTrabajo()">CONTINUAR</button>
        <button class="btn-main" onclick="nuevoInforme()">NUEVO SET</button>

        <div id="recovery-msg" style="display:none; margin-top:15px; padding:15px; background:#fff7ed; border-left:4px solid #f97316; border-radius:8px; font-size:0.85rem; color:#9a3412;">
          <b>¬°Aviso!</b> Tienes un informe sin terminar guardado en la memoria.
        </div>

        <div id="finalized-msg" style="display:none; margin-top:15px; padding:15px; background:#ecfeff; border-left:4px solid #06b6d4; border-radius:8px; font-size:0.85rem; color:#155e75;">
          <b>Informaci√≥n:</b> El √∫ltimo informe fue finalizado y la memoria se limpi√≥ por seguridad.
        </div>

        <div class="switch-row">
          <div class="sw-label">Tema oscuro</div>
          <div id="themeSwitch" class="switch" onclick="toggleTheme()">
            <div class="knob"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Clima</div>
          <div class="weather-row">
            <div class="w-left">
              <div id="wIcon" class="w-icon">‚õÖ</div>
              <div class="w-meta">
                <div id="wCity" class="w-city">Osorno</div>
                <div id="wDesc" class="w-desc">Cargando...</div>
              </div>
            </div>
            <div class="w-right">
              <div id="wTemp" class="w-temp">--¬∞C</div>
              <div id="wMinMax" class="w-minmax">-- / --</div>
            </div>
          </div>

          <div class="weather-actions">
            <button class="btn-sec btn-mini" onclick="refreshWeather()">ACTUALIZAR</button>
            <button class="btn-main btn-mini" onclick="promptCity()">CAMBIAR CIUDAD</button>
          </div>

          <div id="wNote" class="small-note"></div>

          <details class="acc" id="infoUtilAcc">
            <summary>
              INFORMACI√ìN √öTIL
              <span style="font-weight:900;color:var(--muted);">‚ñº</span>
            </summary>
            <div class="acc-body">
              <div class="info-line" id="jplLine">
                JUZGADO DE POLIC√çA LOCAL DE OSORNO DE TURNO:
                <span id="jplValue" style="color:var(--p); font-weight:900;">--</span>
                <div class="small-note" id="jplWeekNote"></div>
              </div>

              <div class="info-line">
                VALOR UTM (CHILE):
                <span id="utmValue" style="color:var(--p); font-weight:900;">Cargando...</span>
                <span id="utmSource" style="color:var(--muted); font-weight:700; font-size:.78rem;"> </span>
                <div class="small-note" id="utmNote"></div>
              </div>

              <div class="small-note">Si no hay internet, algunos valores pueden no actualizar.</div>
            </div>
          </details>
        </div>
      </div>

      <div id="s2" class="step">
        <h2>T√≠tulo del Informe</h2>
        <textarea id="ti_in" rows="4" placeholder="Ej: INSPECCI√ìN T√âCNICA DE..." oninput="saveLocal()"></textarea>
        <button class="btn-main" onclick="guardarTitulo()">Continuar</button>
        <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
      </div>

      <div id="s3" class="step">
        <h2 id="lbl_f">FOTOGRAF√çA 01</h2>

        <label for="f_input" class="btn-label btn-camara">üì∑ TOMAR / GALER√çA</label>
        <input type="file" id="f_input" accept="image/*" onchange="previsualizar()">

        <div id="status"></div>

        <div class="preview-box">
          <h3>Vista previa</h3>
          <img id="previewImg" alt="Vista previa">
          <div class="grid-actions-2">
            <button id="btn-rotL" class="btn-edit btn-mini" onclick="rotarPreview('L')" disabled>GIRAR 90¬∞ IZQ</button>
            <button id="btn-rotR" class="btn-edit btn-mini" onclick="rotarPreview('R')" disabled>GIRAR 90¬∞ DER</button>
          </div>
          <div class="small-note">Las fotos se optimizan autom√°ticamente para evitar errores en tel√©fonos de alta resoluci√≥n.</div>
        </div>

        <textarea id="f_txt" rows="3" placeholder="Descripci√≥n de la imagen..." oninput="saveLocal()"></textarea>

        <button class="btn-main" id="btn-add" onclick="procesarFoto()">Guardar Foto</button>
        <button class="btn-ok" onclick="cambiarPaso(4)">Finalizar Carga</button>
        <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
      </div>

      <div id="s4" class="step">
        <h2>Datos de Cierre</h2>
        <label>Fecha:</label>
        <input type="date" id="f_date" oninput="saveLocal()">
        <label>Nombre:</label>
        <input type="text" id="f_nom" placeholder="SU NOMBRE COMPLETO" oninput="saveLocal()">
        <label>Cargo:</label>
        <input type="text" id="f_rank" placeholder="SU GRADO O CARGO" oninput="saveLocal()">
        <button class="btn-main" onclick="cambiarPaso(5)">Ir a Revisi√≥n</button>
        <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
      </div>

      <div id="s5" class="step">
        <h2>Revisi√≥n Final</h2>

        <div class="review-box">
          <label>T√≠tulo del informe</label>
          <textarea id="ti_in_review" rows="3" placeholder="Ingrese / edite el t√≠tulo..." oninput="actualizarTituloDesdeRevision(this.value)"></textarea>
        </div>

        <div class="hint">En cada foto puedes: girar (izq/der) o cambiar el orden (subir/bajar).</div>
        <div id="render_area"></div>

        <label style="color:#ef4444; font-weight:900; display:block; margin-top:15px;">NOTA FINAL:</label>
        <textarea id="final_conclusion" rows="3" oninput="saveLocal()"></textarea>

        <!-- ‚úÖ Generar PDF se deshabilita visualmente SOLO si faltan descripciones -->
        <button id="btn-pdf" class="btn-main" style="background:var(--accent); margin-top:20px;" onclick="generarPDF()">GENERAR PDF FINAL</button>
        <div id="pdfHint" class="pdf-disabled-hint">Existen fotograf√≠as sin descripci√≥n.</div>

        <button class="btn-sec" onclick="cambiarPaso(3)">+ Agregar m√°s fotos</button>
        <button class="btn-danger" onclick="borrarTodo()">üóëÔ∏è Borrar Todo y Empezar</button>
        <button class="btn-sec" onclick="cambiarPaso(1)">Volver al Men√∫</button>
      </div>
    </div>

    <footer class="app-footer" id="footerText"></footer>
  </div>

  <div id="pdfModal" class="modal-backdrop">
    <div class="modal">
      <h3>Documento generado</h3>
      <p id="pdfModalText">Si el documento no se abre autom√°ticamente, revisa la carpeta Descargas.</p>
      <div class="modal-actions">
        <button id="btnOpenPdf" class="btn-main" style="background:var(--accent); display:none;">ABRIR PDF</button>
        <button class="btn-sec" onclick="closePdfModal()">CERRAR</button>
      </div>
    </div>
  </div>

<script>
  const VERSION_LABEL = "BETA 19.3";
  const BUILD_DATE = "2026-01-15";

  const STORAGE_KEY = 'set_foto_v19';
  const FINALIZED_FLAG = 'set_foto_v19_finalized';

  const DB_NAME = 'set_foto_db_v1';
  const DB_VERSION = 1;
  const STORE_PHOTOS = 'photos';

  const WEATHER_CITY_KEY = "set_weather_city_v1";
  const DEFAULT_CITY = { name: "Osorno", lat: -40.573, lon: -73.133 };

  const UTM_URL = "https://mindicador.cl/api/utm";

  // Semana actual = 2do JPL (seg√∫n regla acordada)
  const JPL_BASE_IS_SECOND = true;

  let photos = [];
  let preview = { blob: null, url: null };
  let lastPdfObjectUrl = null;

  function uuid(){ return 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 9); }
  function revokeAllUrls(){ photos.forEach(p => { if(p.url) URL.revokeObjectURL(p.url); }); }

  function setFooter(){
    document.getElementById("footerText").textContent =
      `CREADA POR HERNAN DIAZ ‚Äî ${VERSION_LABEL} ‚Äî BUILD ${BUILD_DATE}`;
  }

  function clearPreview(){
    if(preview.url) URL.revokeObjectURL(preview.url);
    preview = { blob:null, url:null };
    const img = document.getElementById('previewImg');
    img.style.display='none'; img.src='';
    document.getElementById('btn-rotL').disabled=true;
    document.getElementById('btn-rotR').disabled=true;
  }
  function showPreviewFromBlob(blob){
    clearPreview();
    preview.blob = blob;
    preview.url = URL.createObjectURL(blob);
    const img = document.getElementById('previewImg');
    img.src = preview.url;
    img.style.display = 'block';
    document.getElementById('btn-rotL').disabled=false;
    document.getElementById('btn-rotR').disabled=false;
  }
  function blobToDataURL(blob){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload=()=>resolve(fr.result);
      fr.onerror=reject;
      fr.readAsDataURL(blob);
    });
  }

  const THEME_KEY = "set_theme_dark_v1";
  function applyTheme(isDark){
    document.body.classList.toggle("dark", !!isDark);
    const sw = document.getElementById("themeSwitch");
    sw.classList.toggle("on", !!isDark);
    localStorage.setItem(THEME_KEY, isDark ? "1" : "0");
  }
  function toggleTheme(){
    applyTheme(!document.body.classList.contains("dark"));
  }
  function initTheme(){
    applyTheme(localStorage.getItem(THEME_KEY) === "1");
  }

  function openDB(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = () => {
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE_PHOTOS)){
          db.createObjectStore(STORE_PHOTOS, { keyPath:'id' });
        }
      };
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });
  }
  async function idbPutPhoto(id, blob){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(STORE_PHOTOS,'readwrite');
      tx.objectStore(STORE_PHOTOS).put({ id, blob });
      tx.oncomplete=()=>{ db.close(); resolve(true); };
      tx.onerror=()=>{ db.close(); reject(tx.error); };
    });
  }
  async function idbGetPhoto(id){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(STORE_PHOTOS,'readonly');
      const req = tx.objectStore(STORE_PHOTOS).get(id);
      req.onsuccess=()=>{ db.close(); resolve(req.result ? req.result.blob : null); };
      req.onerror=()=>{ db.close(); reject(req.error); };
    });
  }
  async function idbDeletePhoto(id){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(STORE_PHOTOS,'readwrite');
      tx.objectStore(STORE_PHOTOS).delete(id);
      tx.oncomplete=()=>{ db.close(); resolve(true); };
      tx.onerror=()=>{ db.close(); reject(tx.error); };
    });
  }
  async function idbClearAll(){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(STORE_PHOTOS,'readwrite');
      tx.objectStore(STORE_PHOTOS).clear();
      tx.oncomplete=()=>{ db.close(); resolve(true); };
      tx.onerror=()=>{ db.close(); reject(tx.error); };
    });
  }

  window.onload = () => {
    setFooter();
    initTheme();
    setTimeout(()=>{ document.getElementById('splash').classList.add('hidden'); }, 1200);
    arrancarSeguridadYMenu();
  };

  async function arrancarSeguridadYMenu(){
    const finalized = localStorage.getItem(FINALIZED_FLAG);
    if(finalized === '1'){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(FINALIZED_FLAG);

      revokeAllUrls(); photos=[];
      await idbClearAll();

      document.getElementById('ti_in').value="";
      document.getElementById('f_date').value=new Date().toISOString().split('T')[0];
      document.getElementById('f_nom').value="";
      document.getElementById('f_rank').value="";
      document.getElementById('final_conclusion').value="";
      document.getElementById('finalized-msg').style.display='block';
    } else {
      document.getElementById('finalized-msg').style.display='none';
    }

    await loadLocal();
    actualizarMenuPrincipal();

    updateJPL();
    await initWeather();
    await refreshUTM();
  }

  function actualizarMenuPrincipal(){
    const saved = localStorage.getItem(STORAGE_KEY);
    let hasWork = false;
    if(saved){
      try{
        const data = JSON.parse(saved);
        const titleOk = (data.title||"").trim().length>0;
        const photosOk = Array.isArray(data.photos) && data.photos.length>0;
        const anyFieldOk = ((data.name||"").trim() || (data.rank||"").trim() || (data.conclusion||"").trim());
        hasWork = titleOk || photosOk || anyFieldOk;
      } catch { hasWork=false; }
    }
    document.getElementById('btn-continuar').style.display = hasWork ? 'block' : 'none';
    document.getElementById('recovery-msg').style.display = hasWork ? 'block' : 'none';
  }

  function continuarTrabajo(){
    const title = (document.getElementById('ti_in').value||"").trim();
    if(photos.length>0) cambiarPaso(5);
    else if(title) cambiarPaso(3);
    else cambiarPaso(2);
  }

  async function nuevoInforme(){
    if(confirm("¬øComenzar un informe NUEVO? Esto borrar√° el trabajo guardado.")){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(FINALIZED_FLAG);

      revokeAllUrls(); photos=[];
      await idbClearAll();
      clearPreview();

      document.getElementById('ti_in').value="";
      document.getElementById('f_date').value=new Date().toISOString().split('T')[0];
      document.getElementById('f_nom').value="";
      document.getElementById('f_rank').value="";
      document.getElementById('final_conclusion').value="";

      actualizarMenuPrincipal();
      cambiarPaso(2);
    }
  }

  function saveLocal(){
    const data = {
      title: document.getElementById('ti_in').value,
      photos: photos.map(p=>({ id:p.id, d:p.d, hRatio:p.hRatio })),
      date: document.getElementById('f_date').value,
      name: document.getElementById('f_nom').value,
      rank: document.getElementById('f_rank').value,
      conclusion: document.getElementById('final_conclusion').value
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    actualizarMenuPrincipal();
    updatePdfButtonState(); // ‚úÖ actualizar estado
  }

  async function loadLocal(){
    const saved = localStorage.getItem(STORAGE_KEY);
    revokeAllUrls(); photos=[];
    if(saved){
      const data = JSON.parse(saved);
      document.getElementById('ti_in').value = data.title || "";
      document.getElementById('f_date').value = data.date || new Date().toISOString().split('T')[0];
      document.getElementById('f_nom').value = data.name || "";
      document.getElementById('f_rank').value = data.rank || "";
      document.getElementById('final_conclusion').value = data.conclusion || "";

      const meta = Array.isArray(data.photos) ? data.photos : [];
      for(const m of meta){
        const blob = await idbGetPhoto(m.id);
        if(blob){
          const url = URL.createObjectURL(blob);
          photos.push({ id:m.id, url, d:m.d||"", hRatio:Number(m.hRatio)||1 });
        }
      }
    } else {
      document.getElementById('f_date').value = new Date().toISOString().split('T')[0];
    }
    updatePdfButtonState();
  }

  async function borrarTodo(){
    if(confirm("¬øEst√°s seguro de borrar todo? No se podr√° recuperar.")){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(FINALIZED_FLAG);
      revokeAllUrls(); photos=[];
      await idbClearAll();
      clearPreview();
      location.reload();
    }
  }

  function cambiarPaso(n){
    document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
    document.getElementById('s'+n).classList.add('active');

    if(n===3){
      document.getElementById('lbl_f').innerText = "FOTOGRAF√çA " + (photos.length+1).toString().padStart(2,'0');
      document.getElementById('status').innerText="";
    }
    if(n===5){
      document.getElementById('ti_in_review').value = document.getElementById('ti_in').value || "";
      dibujarRevision();
      updatePdfButtonState(); // ‚úÖ importante al entrar
    }

    document.querySelector('.content').scrollTo(0,0);
    if(n===1) actualizarMenuPrincipal();
  }

  function guardarTitulo(){
    if(!document.getElementById('ti_in').value.trim()) return alert("Por favor ingrese un t√≠tulo.");
    saveLocal();
    cambiarPaso(3);
  }
  function actualizarTituloDesdeRevision(val){
    document.getElementById('ti_in').value = val;
    saveLocal();
  }

  async function optimizeImageFileToBlob(file){
    const arrayBuffer = await file.arrayBuffer();
    const inBlob = new Blob([arrayBuffer], { type:file.type || "image/jpeg" });
    const url = URL.createObjectURL(inBlob);
    const img = new Image();

    return await new Promise((resolve,reject)=>{
      img.onload = async () => {
        try{
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d', { alpha:false });

          const MAX_SIDE = 1600;
          let w = img.width, h = img.height;
          const maxDim = Math.max(w,h);
          if(maxDim > MAX_SIDE){
            const scale = MAX_SIDE / maxDim;
            w = Math.round(w*scale);
            h = Math.round(h*scale);
          }

          canvas.width = w; canvas.height = h;
          ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,w,h);
          ctx.drawImage(img,0,0,w,h);

          const outBlob = await new Promise(res=>{
            canvas.toBlob(b=>res(b), "image/jpeg", 0.72);
          });
          resolve(outBlob);
        } catch(err){ reject(err); }
        finally{ URL.revokeObjectURL(url); }
      };
      img.onerror = ()=>{ URL.revokeObjectURL(url); reject(new Error("No se pudo cargar la imagen.")); };
      img.src = url;
    });
  }

  async function previsualizar(){
    const input = document.getElementById('f_input');
    if(!(input.files && input.files[0])){
      document.getElementById('status').innerText="";
      clearPreview();
      return;
    }
    const file = input.files[0];
    document.getElementById('status').innerText="Imagen seleccionada: " + file.name;
    try{
      const outBlob = await optimizeImageFileToBlob(file);
      showPreviewFromBlob(outBlob);
    } catch(e){
      console.error(e);
      alert("Error al preparar la imagen. Intente con otra foto o una captura de pantalla.");
      clearPreview();
    }
  }

  async function rotarPreview(dir){
    try{
      if(!preview.blob) return;
      const url = URL.createObjectURL(preview.blob);
      const img = new Image();
      img.onload = async () => {
        try{
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.height;
          canvas.height = img.width;

          if(dir==='R'){ ctx.translate(canvas.width,0); ctx.rotate(Math.PI/2); }
          else { ctx.translate(0,canvas.height); ctx.rotate(-Math.PI/2); }

          ctx.fillStyle="#ffffff";
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0);

          const outBlob = await new Promise(res=>{
            canvas.toBlob(b=>res(b), "image/jpeg", 0.78);
          });
          showPreviewFromBlob(outBlob);
        } catch(err){
          console.error(err);
          alert("No se pudo rotar la vista previa.");
        } finally { URL.revokeObjectURL(url); }
      };
      img.onerror = ()=>{ URL.revokeObjectURL(url); alert("No se pudo cargar la imagen para rotar."); };
      img.src = url;
    } catch(e){
      console.error(e);
      alert("Error al rotar la vista previa.");
    }
  }

  async function procesarFoto(){
    const input = document.getElementById('f_input');
    if(!preview.blob) return alert("Debe seleccionar una foto primero (y ver la miniatura).");

    document.getElementById('btn-add').disabled=true;
    document.getElementById('status').innerText="Guardando imagen...";

    try{
      const outBlob = preview.blob;
      const id = uuid();
      await idbPutPhoto(id, outBlob);

      const previewUrl = URL.createObjectURL(outBlob);

      const tmpUrl = URL.createObjectURL(outBlob);
      const img = new Image();
      await new Promise((resolve,reject)=>{
        img.onload=()=>resolve(true);
        img.onerror=reject;
        img.src=tmpUrl;
      });
      const hRatio = img.height / img.width;
      URL.revokeObjectURL(tmpUrl);

      photos.push({ id, url:previewUrl, d:document.getElementById('f_txt').value, hRatio });

      input.value="";
      document.getElementById('f_txt').value="";
      clearPreview();

      document.getElementById('btn-add').disabled=false;
      document.getElementById('status').innerText="¬°Guardada correctamente!";
      saveLocal();

      setTimeout(()=>{ cambiarPaso(3); }, 250);
    } catch(e){
      console.error(e);
      alert("Error al guardar la foto.");
      document.getElementById('btn-add').disabled=false;
      document.getElementById('status').innerText="";
    }
  }

  async function eliminarFoto(index){
    if(confirm("¬øEliminar esta foto?")){
      const p = photos[index];
      if(p?.url) URL.revokeObjectURL(p.url);
      photos.splice(index,1);
      saveLocal();
      dibujarRevision();
      if(p?.id){ try{ await idbDeletePhoto(p.id); }catch(_){} }
    }
  }
  function actualizarDesc(index,val){
    photos[index].d = val;
    saveLocal();
    updatePdfButtonState();
  }
  function moverFoto(index,dir){
    const ni = index+dir;
    if(ni<0 || ni>=photos.length) return;
    const tmp = photos[index];
    photos[index]=photos[ni];
    photos[ni]=tmp;
    saveLocal();
    dibujarRevision();
    updatePdfButtonState();
  }

  async function rotarFoto(index,dir){
    try{
      const p = photos[index];
      if(!p) return;
      const blob = await idbGetPhoto(p.id);
      if(!blob) return alert("No se encontr√≥ la imagen en la base local.");

      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = async () => {
        try{
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.height;
          canvas.height = img.width;

          if(dir==='R'){ ctx.translate(canvas.width,0); ctx.rotate(Math.PI/2); }
          else { ctx.translate(0,canvas.height); ctx.rotate(-Math.PI/2); }

          ctx.fillStyle="#ffffff";
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0);

          const outBlob = await new Promise(res=>{
            canvas.toBlob(b=>res(b), "image/jpeg", 0.8);
          });

          await idbPutPhoto(p.id, outBlob);
          if(p.url) URL.revokeObjectURL(p.url);
          p.url = URL.createObjectURL(outBlob);
          p.hRatio = canvas.height / canvas.width;

          saveLocal();
          dibujarRevision();
        } catch(err){
          console.error(err);
          alert("No se pudo rotar la foto.");
        } finally { URL.revokeObjectURL(url); }
      };
      img.onerror=()=>{ URL.revokeObjectURL(url); alert("No se pudo cargar la imagen para rotar."); };
      img.src=url;
    } catch(e){
      console.error(e);
      alert("Error al rotar la foto.");
    }
  }

  function dibujarRevision(){
    const area = document.getElementById('render_area');
    area.innerHTML="";
    if(photos.length===0) area.innerHTML="<p style='text-align:center'>No hay fotos cargadas.</p>";

    photos.forEach((p,i)=>{
      const div = document.createElement('div');
      div.className='item-foto';
      const upDisabled = (i===0) ? 'disabled' : '';
      const downDisabled = (i===photos.length-1) ? 'disabled' : '';

      div.innerHTML = `
        <div class="item-header">
          <span>FOTO ${(i+1).toString().padStart(2,'0')}</span>
          <span class="btn-delete" onclick="eliminarFoto(${i})">ELIMINAR ‚úï</span>
        </div>
        <img src="${p.url}" style="width:100%; border-radius:10px; border:1px solid #ddd; margin-bottom:6px;">
        <textarea placeholder="Descripci√≥n..." onchange="actualizarDesc(${i}, this.value)">${p.d || ""}</textarea>
        <div class="grid-actions-4">
          <button class="btn-edit btn-mini" onclick="rotarFoto(${i}, 'L')">GIRAR 90¬∞ IZQ</button>
          <button class="btn-edit btn-mini" onclick="rotarFoto(${i}, 'R')">GIRAR 90¬∞ DER</button>
          <button class="btn-main btn-mini" ${upDisabled} onclick="moverFoto(${i}, -1)">SUBIR</button>
          <button class="btn-main btn-mini" ${downDisabled} onclick="moverFoto(${i}, 1)">BAJAR</button>
        </div>
      `;
      area.appendChild(div);
    });

    updatePdfButtonState();
  }

  function normalizeText(s){ return (s||"").replace(/\u00A0/g," ").trim(); }
  function splitLongTokenByWidth(doc, token, maxWidth){
    const out=[]; let chunk="";
    for(const ch of token){
      const test = chunk+ch;
      if(doc.getTextWidth(test)<=maxWidth) chunk=test;
      else { if(chunk) out.push(chunk); chunk=ch; }
    }
    if(chunk) out.push(chunk);
    return out;
  }
  function wordsSafe(doc,text,maxWidth){
    const raw = normalizeText(text).replace(/\s+/g," ");
    if(!raw) return [];
    const tokens = raw.split(" ");
    const out=[];
    for(const tok of tokens){
      if(!tok) continue;
      if(doc.getTextWidth(tok)<=maxWidth) out.push(tok);
      else out.push(...splitLongTokenByWidth(doc,tok,maxWidth));
    }
    return out;
  }
  function drawJustifiedMixedSegments(doc, segments, x, y, width){
    if(!segments || segments.length===0) return;
    if(segments.length===1){
      doc.setFont("helvetica", segments[0].font);
      doc.text(segments[0].text, x, y);
      return;
    }
    let totalW=0;
    const widths=[];
    for(const seg of segments){
      doc.setFont("helvetica", seg.font);
      const w = doc.getTextWidth(seg.text);
      widths.push(w); totalW += w;
    }
    const gaps = segments.length-1;
    if(totalW >= width || gaps<=0){
      let cx=x;
      for(let i=0;i<segments.length;i++){
        doc.setFont("helvetica", segments[i].font);
        doc.text(segments[i].text, cx, y);
        cx += widths[i];
        if(i<segments.length-1){
          doc.setFont("helvetica","normal");
          cx += doc.getTextWidth(" ");
        }
      }
      return;
    }
    const gapSize = (width-totalW)/gaps;
    let cx=x;
    for(let i=0;i<segments.length;i++){
      doc.setFont("helvetica", segments[i].font);
      doc.text(segments[i].text, cx, y);
      cx += widths[i];
      if(i<segments.length-1) cx += gapSize;
    }
  }
  function buildFirstLineWithLabel(doc,label,words,width){
    const line=[];
    doc.setFont("helvetica","bold");
    let currentW = doc.getTextWidth(label);

    doc.setFont("helvetica","normal");
    const minSpace = doc.getTextWidth(" ");
    currentW += minSpace;

    for(const w of words){
      const test = line.length ? (currentW + doc.getTextWidth(w) + minSpace) : (currentW + doc.getTextWidth(w));
      if(test<=width){ line.push(w); currentW=test; }
      else break;
    }
    return line;
  }
  function buildLines(doc,words,width){
    const lines=[]; let line=[];
    for(const w of words){
      const testLine = line.length ? [...line,w] : [w];
      const testText = testLine.join(" ");
      if(doc.getTextWidth(testText)<=width) line=testLine;
      else { if(line.length) lines.push(line); line=[w]; }
    }
    if(line.length) lines.push(line);
    return lines;
  }
  function drawJustifiedWords(doc,words,x,y,width){
    if(!words || words.length===0) return;
    if(words.length===1){ doc.text(words[0],x,y); return; }
    const wordsWidth = words.reduce((sum,w)=>sum+doc.getTextWidth(w),0);
    const gaps = words.length-1;
    if(wordsWidth>=width || gaps<=0){ doc.text(words.join(" "),x,y); return; }
    const gapSize = (width-wordsWidth)/gaps;
    let cx=x;
    for(let i=0;i<words.length;i++){
      doc.text(words[i],cx,y);
      cx += doc.getTextWidth(words[i]);
      if(i<words.length-1) cx += gapSize;
    }
  }
  function printTitleUnderlinedSafe(doc,titleText,pW,usefulW,state,pageBreakFn){
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(0);

    const words = wordsSafe(doc,titleText,usefulW);
    const lines = buildLines(doc,words,usefulW).map(arr=>arr.join(" "));

    for(const line of lines){
      if(state.y > state.bottomLimit) pageBreakFn();
      const tw = doc.getTextWidth(line);
      const tx = (pW - tw)/2;
      doc.text(line, pW/2, state.y, {align:'center'});
      doc.setLineWidth(0.5);
      doc.line(tx, state.y+1.2, tx+tw, state.y+1.2);
      state.y += 7;
    }
    state.y += 6;
  }
  function imprimirEtiquetaEnMismaLinea_CuadradoTotal(doc, etiqueta, texto, x, width, lineHeight, state, pageBreakFn, color=null){
    const t = normalizeText(texto);
    if(!t) return;
    const setColor=()=>{ if(color) doc.setTextColor(color[0],color[1],color[2]); else doc.setTextColor(0); };

    const label = (etiqueta||"").trim();
    doc.setFont("helvetica","normal");
    setColor();
    const allWords = wordsSafe(doc,t,width);

    const firstLineWords = buildFirstLineWithLabel(doc,label,allWords,width);
    const remainingWords = allWords.slice(firstLineWords.length);
    const restLines = buildLines(doc,remainingWords,width);

    if(state.y > state.bottomLimit) pageBreakFn();

    const segments = [{text:label,font:"bold"}, ...firstLineWords.map(w=>({text:w,font:"normal"}))];

    setColor();
    if(restLines.length>0){
      drawJustifiedMixedSegments(doc,segments,x,state.y,width);
    } else {
      let cx=x;
      doc.setFont("helvetica","bold"); doc.text(label,cx,state.y); cx += doc.getTextWidth(label);
      doc.setFont("helvetica","normal"); doc.text(" " + firstLineWords.join(" "), cx, state.y);
    }

    state.y += lineHeight;

    doc.setFont("helvetica","normal");
    for(let i=0;i<restLines.length;i++){
      if(state.y > state.bottomLimit) pageBreakFn();
      const isLast = (i===restLines.length-1);
      if(!isLast) drawJustifiedWords(doc,restLines[i],x,state.y,width);
      else doc.text(restLines[i].join(" "), x, state.y);
      state.y += lineHeight;
    }

    state.y += 3;
    doc.setTextColor(0);
  }

  function hasMissingDescriptions(){
    return photos.some(p => !String(p.d||"").trim());
  }

  function updatePdfButtonState(){
    const btn = document.getElementById('btn-pdf');
    const hint = document.getElementById('pdfHint');
    if(!btn || !hint) return;

    const missing = (photos.length>0 && hasMissingDescriptions());
    btn.disabled = missing;            // ‚úÖ SOLO este bot√≥n queda "apagado"
    hint.style.display = missing ? "block" : "none";
  }

  function formatDateLongEs(isoDate){
    if(!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return isoDate || "";
    const [y,m,d] = isoDate.split("-").map(n=>parseInt(n,10));
    const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    const mes = meses[m-1] || "";
    return `${d} de ${mes} del ${y}`;
  }

  async function generarPDF(){
    const btn = document.getElementById('btn-pdf');

    // Si est√° deshabilitado, no hace nada (pero igual por seguridad)
    if(btn.disabled){
      alert("existen fotografias sin descripcion");
      return;
    }

    btn.innerText="GENERANDO..."; btn.disabled=true;

    try{
      await new Promise(r=>setTimeout(r,50));
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"p", unit:"mm", format:"legal" });

      const pW = doc.internal.pageSize.getWidth();
      const pH = doc.internal.pageSize.getHeight();

      const marginTop = 18;
      const marginBottom = 18;
      const marginSide = 20;
      const usefulW = pW - (marginSide*2);

      const state = { y: marginTop, bottomLimit: pH - marginBottom };
      const pageBreakFn = ()=>{ doc.addPage(); state.y = marginTop; };

      const title = (document.getElementById('ti_in').value||"").toUpperCase();
      printTitleUnderlinedSafe(doc, title, pW, usefulW, state, pageBreakFn);

      const maxImgH = 75;
      doc.setFontSize(12);

      for(let i=0;i<photos.length;i++){
        const p = photos[i];
        const blob = await idbGetPhoto(p.id);
        if(!blob) continue;

        const dataUrl = await blobToDataURL(blob);

        let imgH = maxImgH;
        let imgW = imgH / p.hRatio;
        if(imgW > usefulW){ imgW = usefulW; imgH = imgW * p.hRatio; }

        if(state.y + imgH + 25 > state.bottomLimit) pageBreakFn();

        const xImg = (pW - imgW)/2;
        doc.addImage(dataUrl,'JPEG',xImg,state.y,imgW,imgH);
        doc.setDrawColor(0); doc.setLineWidth(0.3);
        doc.rect(xImg,state.y,imgW,imgH);

        state.y += imgH + 8;

        imprimirEtiquetaEnMismaLinea_CuadradoTotal(
          doc,
          `FOTOGRAF√çA ${(i+1).toString().padStart(2,'0')}:`,
          (p.d||""),
          marginSide,
          usefulW,
          5,
          state,
          pageBreakFn
        );

        state.y += 2;
      }

      const conclusion = document.getElementById('final_conclusion').value;
      if(conclusion && conclusion.trim()){
        if(state.y + 20 > state.bottomLimit) pageBreakFn();
        imprimirEtiquetaEnMismaLinea_CuadradoTotal(
          doc,
          "NOTA:",
          conclusion,
          marginSide,
          usefulW,
          5,
          state,
          pageBreakFn,
          [220,38,38]
        );
      }

      if(state.y + 25 > state.bottomLimit) pageBreakFn();
      else state.y += 6;

      doc.setFontSize(12); doc.setTextColor(0); doc.setFont("helvetica","normal");
      const fechaIso = document.getElementById('f_date').value;
      const fechaLarga = formatDateLongEs(fechaIso);
      doc.text("FECHA: " + fechaLarga, pW - marginSide, state.y, {align:'right'});

      state.y += 18;

      const nombreUpper = (document.getElementById('f_nom').value||"").toUpperCase();
      const cargoUpper = (document.getElementById('f_rank').value||"").toUpperCase();

      doc.setFont("helvetica","bold");
      doc.text(nombreUpper, pW/2, state.y, {align:'center'});

      state.y += 5;
      doc.setFont("helvetica","normal");
      doc.text(cargoUpper, pW/2, state.y, {align:'center'});

      const totalPages = doc.internal.getNumberOfPages();
      for(let i=1;i<=totalPages;i++){
        doc.setPage(i);
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text(`${i}/${totalPages}`, pW - marginSide, 10, {align:'right'});
      }

      const pdfBlob = doc.output("blob");
      const fileName = `Reporte_Fotografico_${VERSION_LABEL.replace(/\s+/g,'_')}.pdf`;

      const a = document.createElement("a");
      a.href = URL.createObjectURL(pdfBlob);
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      if(lastPdfObjectUrl) URL.revokeObjectURL(lastPdfObjectUrl);
      lastPdfObjectUrl = a.href;

      showPdfModal(lastPdfObjectUrl);

      localStorage.setItem(FINALIZED_FLAG,'1');

    } catch(e){
      console.error(e);
      alert("Error al generar el PDF. Intente con menos fotos o fotos m√°s ligeras.");
    } finally {
      btn.innerText="GENERAR PDF FINAL";
      // Al terminar, recalc estado real
      updatePdfButtonState();
    }
  }

  function showPdfModal(pdfUrl){
    const modal = document.getElementById("pdfModal");
    const btnOpen = document.getElementById("btnOpenPdf");
    btnOpen.style.display = pdfUrl ? "block" : "none";
    btnOpen.onclick = ()=>{ try{ window.open(pdfUrl,"_blank"); } catch(_){} };
    modal.style.display="flex";
  }
  function closePdfModal(){ document.getElementById("pdfModal").style.display="none"; }

  /* ====== JPL (Semana texto) ====== */
  function getSantiagoParts(){
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('es-CL', {
      timeZone:'America/Santiago',
      year:'numeric', month:'2-digit', day:'2-digit',
      weekday:'short'
    });
    const partsArr = fmt.formatToParts(now);
    const parts = partsArr.reduce((acc,p)=>{ acc[p.type]=p.value; return acc; }, {});
    const wd = parts.weekday; // lun., mar., etc (depende locale)
    return { y:+parts.year, m:+parts.month, d:+parts.day, wd };
  }

  function getSantiagoWeekdayIndex(){
    // Convertimos a √≠ndice 0..6 (Lun=0)
    const now = new Date();
    const wdEn = new Intl.DateTimeFormat('en-US',{ timeZone:'America/Santiago', weekday:'short' }).format(now);
    const map = { Mon:0, Tue:1, Wed:2, Thu:3, Fri:4, Sat:5, Sun:6 };
    return map[wdEn] ?? 0;
  }

  function formatRangeEs(dayStart, monthStart, dayEnd, monthEnd){
    const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    const ms = meses[(monthStart-1)] || "";
    const me = meses[(monthEnd-1)] || "";
    if(monthStart === monthEnd){
      return `${dayStart} al ${dayEnd} de ${ms}`;
    }
    return `${dayStart} de ${ms} al ${dayEnd} de ${me}`;
    }

  function addDaysUTC(date, days){
    const d = new Date(date.getTime());
    d.setUTCDate(d.getUTCDate() + days);
    return d;
  }

  function getSantiagoDateAtMidnightUTC(y,m,d){
    // aproximaci√≥n estable para rango semanal (solo para texto)
    return new Date(Date.UTC(y, m-1, d, 0, 0, 0));
  }

  function updateJPL(){
    const idx = getSantiagoWeekdayIndex(); // Lun=0
    const p = getSantiagoParts();
    const todayUTC = getSantiagoDateAtMidnightUTC(p.y, p.m, p.d);
    const mondayUTC = addDaysUTC(todayUTC, -idx);
    const sundayUTC = addDaysUTC(mondayUTC, 6);

    // Semana actual = 2do JPL (regla)
    const isSecond = !!JPL_BASE_IS_SECOND;
    const labelShort = isSecond ? "SEGUNDO JPL" : "PRIMER JPL";
    const labelLong = isSecond ? "2do. Juzgado Policial Local" : "1er. Juzgado Policial Local";

    document.getElementById("jplValue").textContent = labelShort;

    const mStart = mondayUTC.getUTCMonth()+1;
    const dStart = mondayUTC.getUTCDate();
    const mEnd = sundayUTC.getUTCMonth()+1;
    const dEnd = sundayUTC.getUTCDate();

    const range = formatRangeEs(dStart, mStart, dEnd, mEnd);
    document.getElementById("jplWeekNote").textContent = `Esta semana: ${labelLong} ‚Äî semana ${range}`;
  }

  /* ====== UTM (Fuente en misma l√≠nea) ====== */
  async function refreshUTM(){
    const v = document.getElementById("utmValue");
    const note = document.getElementById("utmNote");
    const src = document.getElementById("utmSource");

    try{
      v.textContent="Cargando...";
      note.textContent="";
      src.textContent="";

      const res = await fetch(UTM_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("UTM no disponible");
      const data = await res.json();

      const item = (data && data.serie && data.serie[0]) ? data.serie[0] : null;
      if(!item) throw new Error("UTM sin datos");

      const valor = Number(item.valor);
      const fecha = String(item.fecha || "");
      const fechaShort = fecha ? new Date(fecha).toLocaleDateString("es-CL") : "";

      v.textContent = isFinite(valor) ? `$ ${valor.toLocaleString("es-CL")}` : String(item.valor);

      // ‚úÖ Fuente suave en misma l√≠nea
      src.textContent = " (Fuente: mindicador.cl)";

      note.textContent = fechaShort ? `Actualizado: ${fechaShort}` : "Actualizado.";
    } catch(e){
      console.error(e);
      v.textContent="No disponible";
      src.textContent="";
      note.textContent="Sin conexi√≥n o servicio no disponible.";
    }
  }

  /* ====== Clima (igual que antes) ====== */
  function weatherIconFromCode(code){
    const c=Number(code);
    if(c===0) return "‚òÄÔ∏è";
    if(c>=1 && c<=3) return "‚õÖ";
    if(c===45 || c===48) return "‚òÅÔ∏è";
    if((c>=51 && c<=67) || (c>=80 && c<=82) || (c>=95 && c<=99)) return "üåßÔ∏è";
    if(c>=71 && c<=77) return "‚òÅÔ∏è";
    return "‚òÅÔ∏è";
  }
  function weatherTextFromCode(code){
    const c=Number(code);
    if(c===0) return "Despejado";
    if(c>=1 && c<=3) return (c===1)?"Mayormente despejado":(c===2)?"Parcialmente nublado":"Nublado";
    if(c===45 || c===48) return "Neblina";
    if(c>=51 && c<=57) return "Llovizna";
    if(c>=61 && c<=67) return "Lluvia";
    if(c>=71 && c<=77) return "Nieve";
    if(c>=80 && c<=82) return "Chubascos";
    if(c>=95) return "Tormenta";
    return "Nublado";
  }
  async function initWeather(){
    const saved = localStorage.getItem(WEATHER_CITY_KEY);
    if(saved){
      try{
        const obj = JSON.parse(saved);
        if(obj && typeof obj.lat==="number" && typeof obj.lon==="number" && obj.name) window._city=obj;
        else window._city=DEFAULT_CITY;
      } catch { window._city=DEFAULT_CITY; }
    } else window._city=DEFAULT_CITY;

    await refreshWeather();
  }
  async function refreshWeather(){
    const city = window._city || DEFAULT_CITY;

    const wCity=document.getElementById("wCity");
    const wDesc=document.getElementById("wDesc");
    const wTemp=document.getElementById("wTemp");
    const wMinMax=document.getElementById("wMinMax");
    const wIcon=document.getElementById("wIcon");
    const wNote=document.getElementById("wNote");

    wCity.textContent=city.name;
    wDesc.textContent="Cargando...";
    wTemp.textContent="--¬∞C";
    wMinMax.textContent="-- / --";
    wIcon.textContent="‚õÖ";
    wNote.textContent="";

    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=America%2FSantiago`;
      const res = await fetch(url,{ cache:"no-store" });
      if(!res.ok) throw new Error("Clima no disponible");
      const data = await res.json();

      const cw = data.current_weather;
      const daily = data.daily || {};
      const temp = cw ? Math.round(cw.temperature) : null;
      const code = cw ? cw.weathercode : (daily.weathercode && daily.weathercode[0]);
      const tmax = (daily.temperature_2m_max && daily.temperature_2m_max[0]!=null) ? Math.round(daily.temperature_2m_max[0]) : null;
      const tmin = (daily.temperature_2m_min && daily.temperature_2m_min[0]!=null) ? Math.round(daily.temperature_2m_min[0]) : null;

      wIcon.textContent = weatherIconFromCode(code);
      wDesc.textContent = weatherTextFromCode(code);
      if(temp!=null) wTemp.textContent = `${temp}¬∞C`;
      if(tmin!=null && tmax!=null) wMinMax.textContent = `${tmin}¬∞ / ${tmax}¬∞`;

      const upd = cw && cw.time ? new Date(cw.time).toLocaleString("es-CL") : "";
      wNote.textContent = upd ? `Actualizado: ${upd}` : "";
    } catch(e){
      console.error(e);
      wDesc.textContent="No se pudo cargar.";
      wNote.textContent="Sin conexi√≥n o servicio no disponible.";
    }
  }
  async function promptCity(){
    const name = prompt("Ingrese ciudad (ej: Osorno, Valdivia, Santiago):");
    if(!name) return;
    try{
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=5&language=es&format=json`;
      const res = await fetch(url,{ cache:"no-store" });
      if(!res.ok) throw new Error("No se pudo buscar");
      const data = await res.json();
      const results = data.results || [];
      if(!results.length) return alert("No se encontraron resultados.");
      const r = results[0];
      const city = { name:`${r.name}${r.admin1? ", "+r.admin1:""}`, lat:r.latitude, lon:r.longitude };
      window._city=city;
      localStorage.setItem(WEATHER_CITY_KEY, JSON.stringify(city));
      await refreshWeather();
    } catch(e){
      console.error(e);
      alert("No se pudo cambiar la ciudad (sin conexi√≥n).");
    }
  }
</script>
</body>
</html>
